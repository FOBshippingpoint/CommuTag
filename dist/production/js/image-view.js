(()=>{var t={6528:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,'html,body{height:100%;margin:0;padding:0;background-color:#edffef}*{box-sizing:border-box;font-family:"微軟正黑體", "Microsoft JhengHei"}\n',""]);const r=o},4026:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".annotator-bbox{width:100%;height:100%;position:relative}.annotator-bbox .tool-set{position:absolute;display:inline-block;bottom:10px;left:10px}\n",""]);const r=o},1757:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".annotator-image{width:100%;height:100%}.annotator-image .image{margin:auto;max-width:800px;max-height:100%}\n",""]);const r=o},9712:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".annotator-view{width:100%;height:100%}\n",""]);const r=o},1106:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".annotator{width:100%;height:100%}\n",""]);const r=o},6930:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".dataset-select{width:100%}\n",""]);const r=o},3520:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".form-reply{width:100%}\n",""]);const r=o},3901:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".image-control{width:100%;padding:5px;background-color:#eeeeee}.image-control .form-area{margin:5px;padding:5px 10px;border:1px solid #888888;border-radius:5px}\n",""]);const r=o},5253:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".image-info{width:100%;height:100%}\n",""]);const r=o},6288:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".image-view{width:100%;height:100%}\n",""]);const r=o},7108:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".location-select{width:100%}.location-select .map{width:100%;height:300px}\n",""]);const r=o},7256:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".tag-select{width:100%}\n",""]);const r=o},4326:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".tag-select{width:100%}\n",""]);const r=o},9007:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});var i=a(8081),n=a.n(i),s=a(3645),o=a.n(s)()(n());o.push([t.id,".topbar{width:100%}.topbar a{text-decoration:none}\n",""]);const r=o},3645:t=>{"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var a="",i=void 0!==e[5];return e[4]&&(a+="@supports (".concat(e[4],") {")),e[2]&&(a+="@media ".concat(e[2]," {")),i&&(a+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),a+=t(e),i&&(a+="}"),e[2]&&(a+="}"),e[4]&&(a+="}"),a})).join("")},e.i=function(t,a,i,n,s){"string"==typeof t&&(t=[[null,t,void 0]]);var o={};if(i)for(var r=0;r<this.length;r++){var l=this[r][0];null!=l&&(o[l]=!0)}for(var c=0;c<t.length;c++){var d=[].concat(t[c]);i&&o[d[0]]||(void 0!==s&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=s),a&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=a):d[2]=a),n&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=n):d[4]="".concat(n)),e.push(d))}},e}},8081:t=>{"use strict";t.exports=function(t){return t[1]}},7896:(t,e,a)=>{var i=a(3379),n=a(6528);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},1255:(t,e,a)=>{var i=a(3379),n=a(4026);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},2025:(t,e,a)=>{var i=a(3379),n=a(1757);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},2083:(t,e,a)=>{var i=a(3379),n=a(9712);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},9481:(t,e,a)=>{var i=a(3379),n=a(1106);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},3529:(t,e,a)=>{var i=a(3379),n=a(6930);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},6044:(t,e,a)=>{var i=a(3379),n=a(3520);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},8029:(t,e,a)=>{var i=a(3379),n=a(3901);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},2155:(t,e,a)=>{var i=a(3379),n=a(5253);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},4280:(t,e,a)=>{var i=a(3379),n=a(6288);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},5904:(t,e,a)=>{var i=a(3379),n=a(7108);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},9085:(t,e,a)=>{var i=a(3379),n=a(7256);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},4973:(t,e,a)=>{var i=a(3379),n=a(4326);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},4890:(t,e,a)=>{var i=a(3379),n=a(9007);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.id,n,""]]);i(n,{insert:"head",singleton:!1}),t.exports=n.locals||{}},3379:(t,e,a)=>{"use strict";var i,n=function(){var t={};return function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(t){a=null}t[e]=a}return t[e]}}(),s=[];function o(t){for(var e=-1,a=0;a<s.length;a++)if(s[a].identifier===t){e=a;break}return e}function r(t,e){for(var a={},i=[],n=0;n<t.length;n++){var r=t[n],l=e.base?r[0]+e.base:r[0],c=a[l]||0,d="".concat(l," ").concat(c);a[l]=c+1;var h=o(d),u={css:r[1],media:r[2],sourceMap:r[3]};-1!==h?(s[h].references++,s[h].updater(u)):s.push({identifier:d,updater:f(u,e),references:1}),i.push(d)}return i}function l(t){var e=document.createElement("style"),i=t.attributes||{};if(void 0===i.nonce){var s=a.nc;s&&(i.nonce=s)}if(Object.keys(i).forEach((function(t){e.setAttribute(t,i[t])})),"function"==typeof t.insert)t.insert(e);else{var o=n(t.insert||"head");if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(e)}return e}var c,d=(c=[],function(t,e){return c[t]=e,c.filter(Boolean).join("\n")});function h(t,e,a,i){var n=a?"":i.media?"@media ".concat(i.media," {").concat(i.css,"}"):i.css;if(t.styleSheet)t.styleSheet.cssText=d(e,n);else{var s=document.createTextNode(n),o=t.childNodes;o[e]&&t.removeChild(o[e]),o.length?t.insertBefore(s,o[e]):t.appendChild(s)}}function u(t,e,a){var i=a.css,n=a.media,s=a.sourceMap;if(n?t.setAttribute("media",n):t.removeAttribute("media"),s&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleSheet)t.styleSheet.cssText=i;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(i))}}var g=null,m=0;function f(t,e){var a,i,n;if(e.singleton){var s=m++;a=g||(g=l(e)),i=h.bind(null,a,s,!1),n=h.bind(null,a,s,!0)}else a=l(e),i=u.bind(null,a,e),n=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(a)};return i(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;i(t=e)}else n()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=(void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i));var a=r(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var i=0;i<a.length;i++){var n=o(a[i]);s[n].references--}for(var l=r(t,e),c=0;c<a.length;c++){var d=o(a[c]);0===s[d].references&&(s[d].updater(),s.splice(d,1))}a=l}}}}},e={};function a(i){var n=e[i];if(void 0!==n)return n.exports;var s=e[i]={id:i,exports:{}};return t[i](s,s.exports,a),s.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var i in e)a.o(e,i)&&!a.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.nc=void 0,(()=>{"use strict";var t=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-layout",{staticClass:"image-view bg-grey-1 shadow-2",attrs:{view:"lHh lpr lFf",container:""}},[a("q-header",[a("topbar",{attrs:{user:t.user}})],1),t._v(" "),a("q-page-container",[a("image-control",{attrs:{user:t.user,dataset:t.dataset,image:t.image}})],1),t._v(" "),a("q-footer",[a("q-btn",{staticClass:"full-width bg-grey-8",attrs:{icon:"home",label:"回資料集"},on:{click:function(e){return t.GoToDataset()}}})],1)],1)};t._withStripped=!0;const e=function(){for(var t=window.location.search.substring(1).split("&"),e={},a=0;a<t.length;a++){var i=t[a].split("=");e[i[0]]=i[1]}return e};a(7896);var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"topbar bg-grey-8 text-white"},[a("q-toolbar",{staticClass:"q-px-md",attrs:{square:""}},[t.useMenu?a("q-btn",{attrs:{flat:"",round:"",icon:"menu"},on:{click:function(e){return t.ToggleMenu()}}}):t._e(),t._v(" "),a("a",{attrs:{href:"/"}},[a("q-btn",{attrs:{flat:"","no-caps":""}},[a("q-avatar",{attrs:{size:"md",square:""}},[a("img",{attrs:{src:t.logo}})]),t._v(" "),a("div",{staticClass:"gt-xs q-px-md text-white text-h5 inline"},[t._v(t._s(t.title))])],1)],1),t._v(" "),a("q-space"),t._v(" "),t.user?a("q-item",{attrs:{clickable:"",tag:"a",href:"/account"}},[a("q-avatar",{attrs:{size:"lg"}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:t.user.icon}})]),t._v(" "),a("q-item-section",{staticClass:"q-px-sm"},[a("q-item-label",{staticClass:"text-h6"},[t._v(t._s(t.user.name))])],1)],1):a("q-item",{attrs:{clickable:"",tag:"a",href:"/login"}},[a("q-icon",{attrs:{size:"md",name:"account_box"}}),t._v(" "),a("q-item-section",[a("q-item-label",{staticClass:"text-h6"},[t._v("登入")])],1)],1)],1)],1)};i._withStripped=!0;const n={name:"topbar",props:{user:Object,useMenu:Boolean},data:function(){return{title:"",logo:"/static/image/logo.png"}},created:function(){$.get("/site-info",function(t){"ok"==t.status&&(this.title=t.data.title,this.logo=t.data.logo)}.bind(this))},methods:{ToggleMenu:function(){this.$emit("toggleMenu")}}};function s(t,e,a,i,n,s,o,r){var l,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=a,c._compiled=!0),i&&(c.functional=!0),s&&(c._scopeId="data-v-"+s),o?(l=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),n&&n.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(o)},c._ssrRegister=l):n&&(l=r?function(){n.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:n),l)if(c.functional){c._injectStyles=l;var d=c.render;c.render=function(t,e){return l.call(e),d(t,e)}}else{var h=c.beforeCreate;c.beforeCreate=h?[].concat(h,l):[l]}return{exports:t,options:c}}a(4890);const o=s(n,i,[],!1,null,null,null).exports;var r=function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.dataset&&t.image?a("div",{staticClass:"image-control"},[a("q-card",{staticClass:"full-width",attrs:{flat:""}},[a("div",{staticStyle:{height:"60vh"}},[a("annotator-view",{attrs:{dataset:t.dataset,image:t.image}})],1),t._v(" "),a("q-card-section",[t.image.time?a("q-chip",{staticClass:"transparent",attrs:{dense:"",icon:"access_time"}},[t._v(t._s(t.image.time))]):t._e(),t._v(" "),t.image.lat&&t.image.lng?a("q-chip",{staticClass:"transparent",attrs:{dense:"",clickable:"",icon:"room"},on:{click:function(e){return t.ViewLocation()}}},[t._v("觀看地點")]):t._e(),t._v(" "),t.image.annotation?a("q-chip",{staticClass:"transparent",attrs:{dense:""}},[t._v(t._s("認同數 / 驗證數 : "+t.AgreeVerifyRatio))]):t._e(),t._v(" "),a("div",{staticClass:"row"},[t.uploader?a("div",{staticClass:"q-pa-sm",on:{click:function(e){return t.OpenUserInfo(t.uploader)}}},[t._v("上傳者:\n\t\t\t\t\t"),a("span",{staticClass:"cursor-pointer text-blue-10"},[t._v(t._s(t.uploader.name))])]):t._e(),t._v(" "),t.annotator?a("div",{staticClass:"q-pa-sm",on:{click:function(e){return t.OpenUserInfo(t.annotator)}}},[t._v("標註者:\n\t\t\t\t\t"),a("span",{staticClass:"cursor-pointer text-blue-10"},[t._v(t._s(t.annotator.name))])]):t._e()]),t._v(" "),t.image.remark&&""!=t.image.remark?a("div",{staticClass:"q-mx-sm q-my-none",staticStyle:{"white-space":"pre-line","word-wrap":"break-word"}},[t._v(t._s(t.image.remark))]):t._e(),t._v(" "),t.dataset.form&&t.image.formReply?a("div",{staticClass:"form-area"},[a("div",{staticClass:"text-subtitle1"},[t._v("表單資料")]),t._v(" "),t._l(t.dataset.form.itemArr,(function(e,i){return a("div",{staticClass:"row q-gutter-sm"},[a("div",[t._v(t._s(i+1)+". "+t._s(e.quest))]),t._v(" "),t.image.formReply[e.id]?a("div",[t._v("\n\t\t\t\t\t\t"+t._s("checkbox"==e.type?t.image.formReply[e.id].value.join(", "):t.image.formReply[e.id].value)+"\n\t\t\t\t\t")]):t._e()])}))],2):t._e()],1),t._v(" "),a("q-card-actions",[t.editable?a("div",[t.dataset&&t.dataset.enableAnnotation?a("q-btn",{attrs:{flat:"",label:t.image.annotation?"協助驗證":"協助標註"},on:{click:function(e){return t.AnnotateImage()}}}):t._e(),t._v(" "),a("q-btn",{attrs:{flat:"",label:"影像網址"},on:{click:function(e){return t.GoToImageUrl()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"下載影像"},on:{click:function(e){return t.DownloadImage()}}}),t._v(" "),t.CheckAnnotationDelete?a("q-btn",{attrs:{flat:"",label:"刪除標註"},on:{click:function(e){return t.DeleteAnnotation()}}}):t._e(),t._v(" "),t.CheckEditAuth?a("q-btn",{attrs:{flat:"",label:"編輯資訊"},on:{click:function(e){return t.OpenInfoEditor()}}}):t._e(),t._v(" "),t.CheckEditAuth?a("q-btn",{attrs:{flat:"",label:"刪除影像"},on:{click:function(e){return t.DeleteImage()}}}):t._e()],1):t._e(),t._v(" "),t.dataset&&"riverlog"==t.dataset.externalLink?a("q-btn",{attrs:{flat:"",label:"前往山河事件簿"},on:{click:function(e){return t.GoToExternalLink()}}}):t._e(),t._v(" "),t.dataset&&"purbao"==t.dataset.externalLink?a("q-btn",{attrs:{flat:"",label:"前往紫豹在哪裡"},on:{click:function(e){return t.GoToExternalLink()}}}):t._e()],1)],1),t._v(" "),t.showNavigate?a("div",[a("q-page-sticky",{attrs:{position:"left",offset:[9,0]}},[a("q-btn",{attrs:{round:"",color:"accent",icon:"arrow_back"},on:{click:function(e){return t.GoToPrev()}}})],1),t._v(" "),a("q-page-sticky",{attrs:{position:"right",offset:[9,0]}},[a("q-btn",{staticClass:"rotate-90",attrs:{round:"",color:"accent",icon:"arrow_upward"},on:{click:function(e){return t.GoToNext()}}})],1),t._v(" "),a("q-page-sticky",{attrs:{position:"top-right",offset:[9,-9]}},[a("q-btn",{attrs:{round:"",color:"primary",icon:"close"},on:{click:function(e){return t.CloseView()}}})],1)],1):t._e(),t._v(" "),t.dataset?a("q-dialog",{attrs:{maximized:"",persistent:""},model:{value:t.openAnnotator,callback:function(e){t.openAnnotator=e},expression:"openAnnotator"}},[a("annotator",{attrs:{user:t.user,dataset:t.dataset,image:t.image},on:{done:function(e){return t.FinishAnnotation()},skip:function(e){t.openAnnotator=!1}}}),t._v(" "),a("div",[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],staticClass:"bg-teal text-white q-ma-md absolute-top-right",attrs:{round:"",icon:"close"}})],1)],1):t._e(),t._v(" "),t.editImage?a("q-dialog",{model:{value:t.openInfoEdit,callback:function(e){t.openInfoEdit=e},expression:"openInfoEdit"}},[a("image-info",{ref:"imageInfo",attrs:{dataset:t.dataset,initDataTime:t.editImage.dataTime,initLat:t.editImage.lat,initLng:t.editImage.lng,initRemark:t.editImage.remark,initReply:t.editImage.formReply},on:{confirm:function(e){return t.UpdateImageInfo()},cancel:function(e){t.openInfoEdit=!1}}})],1):t._e(),t._v(" "),t.image&&t.image.lat&&t.image.lng?a("q-dialog",{model:{value:t.openLocationView,callback:function(e){t.openLocationView=e},expression:"openLocationView"}},[a("q-card",{staticClass:"full-width q-pa-sm"},[a("div",{staticClass:"text-h6"},[t._v("資料地點")]),t._v(" "),a("location-select",{ref:"locationSelect",attrs:{mode:"view"}}),t._v(" "),a("div",{staticClass:"text-center"},[t._v("座標: "+t._s(t.image.lat.toFixed(5)+" "+t.image.lng.toFixed(5)))]),t._v(" "),a("q-card-actions",{attrs:{align:"center"}},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1):t._e(),t._v(" "),t.user&&t.targetUser?a("q-dialog",{model:{value:t.openUserInfo,callback:function(e){t.openUserInfo=e},expression:"openUserInfo"}},[a("q-card",{staticClass:"q-pa-lg"},[a("div",{staticClass:"row justify-center q-pa-sm"},[a("q-avatar",{attrs:{size:"150px"}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:t.targetUser.photo}})])],1),t._v(" "),a("div",{staticClass:"column q-pa-sm"},[a("div",[t._v(t._s(t.targetUser.name))]),t._v(" "),a("div",[t._v(t._s(t.targetUser.contactEmail))])]),t._v(" "),a("q-card-actions",{attrs:{align:"center"}},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1):t._e()],1):t._e()};r._withStripped=!0;var l=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator bg-grey-9"},[t.datasetSelect&&t.imageSelect&&t.taskSelect?a("div",{staticClass:"fit"},["image"==t.datasetSelect.annotationType?a("annotator-image",{ref:"annotatorImage",attrs:{dataset:t.datasetSelect,image:t.imageSelect,task:t.taskSelect},on:{setAnnotation:t.UploadAnnotation,setVerification:t.UploadVerification,skipTask:t.SkipTask}}):t._e(),t._v(" "),"bbox"==t.datasetSelect.annotationType?a("annotator-bbox",{ref:"annotatorBBox",attrs:{dataset:t.datasetSelect,image:t.imageSelect,task:t.taskSelect},on:{setAnnotation:t.UploadAnnotation,setVerification:t.UploadVerification,skipTask:t.SkipTask}}):t._e()],1):a("div",{staticClass:"fit row justify-center items-center"},[a("div",{staticClass:"text-h5 text-white"},[t._v(t._s(t.status))])]),t._v(" "),a("q-dialog",{model:{value:t.openDatasetSelect,callback:function(e){t.openDatasetSelect=e},expression:"openDatasetSelect"}},[a("dataset-select",{ref:"datasetSelect",attrs:{forAnnotation:""},on:{confirm:function(e){return t.ChangeDataset()},cancel:function(e){t.openDatasetSelect=!1}}})],1),t._v(" "),a("q-page-sticky",{attrs:{position:"top-left",offset:[18,18]}},[a("div",{staticClass:"column q-gutter-sm"},[a("q-btn",{staticClass:"bg-primary text-white",attrs:{flat:"",round:"",size:"md",icon:"help",disable:null==t.imageSelect},on:{click:function(e){return t.OpenHelp()}}},[a("q-tooltip",{attrs:{"content-class":"bg-primary"}},[t._v("如何標註")])],1),t._v(" "),a("q-btn",{staticClass:"bg-primary text-white",attrs:{flat:"",round:"",size:"md",icon:"view_quilt",disable:null!=t.dataset},on:{click:function(e){t.openDatasetSelect=!0}}},[a("q-tooltip",{attrs:{"content-class":"bg-primary"}},[t._v("選擇資料集")])],1)],1)])],1)};l._withStripped=!0;var c=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-card",{staticClass:"dataset-select full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇資料集")]),t._v(" "),t.lastDataset?a("div",[a("div",{staticClass:"text-subtitle2"},[t._v("上次使用")]),t._v(" "),a("q-item",{attrs:{clickable:"",active:-1==t.selectIndex,"active-class":"bg-green-2"},on:{click:function(e){return t.SelectItem(-1)},dblclick:function(e){return t.ConfirmSelect()}}},[a("q-item-section",{attrs:{avatar:""}},[a("q-avatar",{attrs:{square:"",rounded:""}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:t.lastDataset.picCover||"/static/image/logo-16-9.png"}})])],1),t._v(" "),a("q-item-section",[a("q-item-label",[t._v(t._s(t.lastDataset.name))])],1)],1)],1):t._e(),t._v(" "),a("q-scroll-area",{staticStyle:{height:"300px"}},[a("q-infinite-scroll",{ref:"datasetScroll",on:{load:t.LoadMoreDataset},scopedSlots:t._u([{key:"loading",fn:function(){return[a("div",{staticClass:"row justify-center q-my-md"},[a("q-spinner-dots",{attrs:{color:"primary",size:"40px"}})],1)]},proxy:!0}])},[a("q-input",{attrs:{placeholder:"輸入篩選文字",outlined:"",dense:"",square:""},on:{change:function(e){return t.ReloadDataset()}},model:{value:t.searchKey,callback:function(e){t.searchKey=e},expression:"searchKey"}}),t._v(" "),a("q-list",{attrs:{bordered:"",separator:""}},t._l(t.datasetArr,(function(e,i){return a("q-item",{key:i,attrs:{clickable:"",active:t.selectIndex==i,"active-class":"bg-green-2"},on:{click:function(e){return t.SelectItem(i)},dblclick:function(e){return t.ConfirmSelect()}}},[a("q-item-section",{attrs:{avatar:""}},[a("q-avatar",{attrs:{square:"",rounded:""}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:e.picCover||"/static/image/logo-16-9.png"}})])],1),t._v(" "),a("q-item-section",[a("q-item-label",[t._v(t._s(e.name))])],1)],1)})),1)],1)],1)],1),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{attrs:{flat:"",label:"確定"},on:{click:function(e){return t.ConfirmSelect()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"取消"},on:{click:function(e){return t.CancelSelect()}}})],1)],1)};c._withStripped=!0;const d={name:"dataset-select",props:{forUpload:Boolean,forAnnotation:Boolean},components:{},data:function(){return{searchKey:"",datasetArr:[],hasMore:!0,selectIndex:-1,lastDataset:{}}},created:function(){this.GetLastDataset()},methods:{GetLastDataset:function(){window.localStorage,this.lastDataset=JSON.parse(localStorage.getItem("lastDataset"))},SetLastDataset:function(t){window.localStorage,localStorage.setItem("lastDataset",JSON.stringify(t))},LoadMoreDataset:function(t,e){var a="/dataset/list-dataset";a+="?page="+(t-1),a+="&sort=updatedAt",a+="&orderType=desc",this.forUpload&&(a+="&enableUpload=1"),this.forAnnotation&&(a+="&enableAnnotation=1"),a+="&keyword="+this.searchKey,$.get(a,function(t){"ok"==t.status&&(this.hasMore=t.data.hasMore,this.hasMore||this.$refs.datasetScroll.stop(),this.datasetArr=this.datasetArr.concat(t.data.dataset),e())}.bind(this))},ReloadDataset:function(){this.datasetArr=[],this.$refs.datasetScroll.reset(),this.$refs.datasetScroll.resume(),this.selectIndex=-1},GetSelectDataset:function(){return-1==this.selectIndex&&this.lastDataset?this.lastDataset:this.selectIndex<0||this.selectIndex>=this.datasetArr.length?null:this.datasetArr[this.selectIndex]},SelectItem:function(t){this.selectIndex=t,this.$emit("change")},ConfirmSelect:function(){return-1==this.selectIndex&&this.lastDataset?this.$emit("confirm"):this.selectIndex<0||this.selectIndex>=this.datasetArr.length?alert("請選擇資料集"):(this.SetLastDataset(this.datasetArr[this.selectIndex]),void this.$emit("confirm"))},CancelSelect:function(){this.$emit("cancel")}}};a(3529);const h=s(d,c,[],!1,null,null,null).exports;var u=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator-image"},["view"==t.task?a("div",{staticClass:"column fit"},[a("q-img",{staticClass:"col",attrs:{contain:"",src:t.image.url}},[t.image.annotation?a("div",{staticClass:"absolute-bottom text-subtitle1 text-center"},[t._v("\n\t\t\t\t"+t._s(t.GetSelectTag(t.image.annotation.annotation))+"\n\t\t\t")]):t._e()])],1):a("div",{staticClass:"column fit"},[a("q-img",{staticClass:"col q-my-md",attrs:{contain:"",src:t.image.url}}),t._v(" "),"annotate"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"確定"},on:{click:function(e){return t.SetAnnotation()}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,2135591169)},[a("div",{staticClass:"row items-center"},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t\t請選擇符合此影像的標籤\n\t\t\t\t")]),t._v(" "),a("tag-checkbox",{ref:"tagCheckbox",attrs:{dataset:t.dataset}})],1)]):t._e(),t._v(" "),"verify"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"是"},on:{click:function(e){return t.SetVerification(!0)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"否"},on:{click:function(e){return t.SetVerification(!1)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,767176183)},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t請驗證此影像是否為 "+t._s(t.GetSelectTag(t.image.annotation.annotation))+"?\n\t\t\t")])]):t._e()],1),t._v(" "),a("q-dialog",{model:{value:t.openHelp,callback:function(e){t.openHelp=e},expression:"openHelp"}},[a("q-card",{staticClass:"full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("如何標註")]),t._v(" "),a("ul",{staticClass:"text-subtitle2"},[a("li",[t._v("選擇符合此影像的標籤並按「確定」。")])]),t._v(" "),a("div",{staticClass:"text-h6"},[t._v("如何驗證")]),t._v(" "),a("ul",{staticClass:"text-subtitle2"},[a("li",[t._v("若此影像符合選擇的標籤，按「是」。反之按「否」。")])])]),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1)],1)};u._withStripped=!0;var g=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tag-checkbox"},[a("q-btn",{staticClass:"q-ma-sm bg-brown-8",on:{click:function(e){t.openTagSelect=!0}}},[t._v(t._s(t.btTitle))]),t._v(" "),a("q-dialog",{model:{value:t.openTagSelect,callback:function(e){t.openTagSelect=e},expression:"openTagSelect"}},[a("q-card",[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇標籤")]),t._v(" "),t._l(t.tagSelect,(function(e){return a("q-checkbox",{key:e.name,attrs:{label:e.name},on:{input:function(e){return t.UpdateSelect()}},model:{value:e.value,callback:function(a){t.$set(e,"value",a)},expression:"tag.value"}})}))],2),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{attrs:{flat:"",label:"確定"},on:{click:function(e){return t.ConfirmSelect()}}})],1)],1)],1)],1)};g._withStripped=!0;const m={name:"tag-checkbox",props:{dataset:Object},components:{},data:function(){return{btTitle:"選擇標籤",tagSelect:[],openTagSelect:!1}},created:function(){this.tagSelect=[];for(var t=0;t<this.dataset.tagArr.length;t++){var e=this.dataset.tagArr[t];this.tagSelect.push({name:e,value:!1})}},methods:{UpdateSelect:function(){for(var t=0,e=0;e<this.tagSelect.length;e++)this.tagSelect[e].value&&t++;this.btTitle=0==t?"選擇標籤":t+"個選擇"},ConfirmSelect:function(){this.openTagSelect=!1,this.$emit("confirm")}}};a(9085);const f={name:"annotator-image",components:{"tag-checkbox":s(m,g,[],!1,null,null,null).exports},props:{dataset:Object,image:Object,task:String,status:String},data:function(){return{openHelp:!1}},mounted:function(){},methods:{SetAnnotation:function(){this.$emit("setAnnotation")},SetVerification:function(t){this.$emit("setVerification",t)},GetAnnotation:function(){return this.$refs.tagCheckbox.tagSelect},SkipTask:function(){this.$emit("skipTask")},GetSelectTag:function(t){for(var e="",a=0;a<t.length;a++){var i=t[a];"true"==i.value&&(e+="#"+i.name+" ")}return e}}};a(2025);const p=s(f,u,[],!1,null,null,null).exports;var v=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator-bbox"},[a("img",{ref:"srcImage",staticClass:"hidden",attrs:{src:t.image.url},on:{load:t.ChangeImage}}),t._v(" "),"view"==t.task?a("div",{staticClass:"column fit"},[a("div",{ref:"viewCanvas",staticClass:"col"})]):a("div",{staticClass:"column fit"},[a("div",{staticClass:"col q-ma-auto relative-position"},[a("div",{ref:"editCanvas",staticClass:"fit"}),t._v(" "),"annotate"==t.task?a("div",{staticClass:"tool-set"},[a("q-btn-toggle",{attrs:{glossy:"",size:"sm",options:t.toolOption,color:"grey-1","text-color":"grey-6"},on:{input:function(e){return t.ChangeTool()}},scopedSlots:t._u([{key:"bbox",fn:function(){return[a("q-icon",{attrs:{name:"aspect_ratio"}})]},proxy:!0},{key:"move",fn:function(){return[a("q-icon",{attrs:{name:"pan_tool"}})]},proxy:!0}],null,!1,1866943705),model:{value:t.tool,callback:function(e){t.tool=e},expression:"tool"}})],1):t._e()]),t._v(" "),"annotate"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"確定"},on:{click:function(e){return t.SetAnnotation()}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,2135591169)},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t請框選出影像中的物件並給予標籤\n\t\t\t")])]):t._e(),t._v(" "),"verify"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"是"},on:{click:function(e){return t.SetVerification(!0)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"否"},on:{click:function(e){return t.SetVerification(!1)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,767176183)},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t請驗證此影像框選的物件及標籤是否正確?\n\t\t\t")])]):t._e()],1),t._v(" "),a("q-dialog",{attrs:{persistent:""},model:{value:t.openTagSelect,callback:function(e){t.openTagSelect=e},expression:"openTagSelect"}},[a("q-card",[a("q-card-section",[a("div",{staticClass:"text-h6 q-py-sm"},[t._v("請選擇標籤")]),t._v(" "),a("tag-select",{ref:"tagSelect",attrs:{dataset:t.dataset}})],1),t._v(" "),a("q-separator"),t._v(" "),a("q-card-actions",{attrs:{align:"around"}},[t.newRect?a("q-btn",{attrs:{flat:"",label:"新增"},on:{click:function(e){return t.AddAnnotation()}}}):a("q-btn",{attrs:{flat:"",label:"修改"},on:{click:function(e){return t.ConfirmTagSelect()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"取消"},on:{click:function(e){return t.CancelTagSelect()}}}),t._v(" "),t.target?a("q-btn",{attrs:{flat:"",label:"刪除"},on:{click:function(e){return t.RemoveAnnotation()}}}):t._e()],1)],1)],1),t._v(" "),a("q-dialog",{model:{value:t.openHelp,callback:function(e){t.openHelp=e},expression:"openHelp"}},[a("q-card",{staticClass:"full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("如何標註")]),t._v(" "),a("ul",{staticClass:"text-subtitle2"},[a("li",[t._v("框選出影像中所有符合標籤的物件並選擇對應的標籤，完成後按「確定」送出。")]),t._v(" "),a("li",[t._v("優良的標註應符合以下條件：\n\t\t\t\t\t\t"),a("ol",[a("li",[t._v("框選出所有符合標籤的物件並選擇正確的物件標籤")]),t._v(" "),a("li",[t._v("方框應完整涵蓋該物件可以看到的範圍(不包含被遮住的部分)，並且盡量逼近該物件的大小")]),t._v(" "),a("li",[t._v("一個方框只能框一個物件，若有多個物件請分不同方框框選")])])])]),t._v(" "),a("div",{staticClass:"text-h6"},[t._v("如何驗證")]),t._v(" "),a("ol",{staticClass:"text-subtitle2"},[a("li",[t._v("確認影像中框選出的物件標籤是否正確")]),t._v(" "),a("li",[t._v("確認方框是否完整涵蓋該物件可以看到的範圍(不包含被遮住的部分)，並且盡量逼近該物件的大小")]),t._v(" "),a("li",[t._v("確認一個方框只能框一個物件，若有多個物件需分成不同方框框選")]),t._v(" "),a("li",[t._v("確認是否已框選出所有符合標籤的物件")]),t._v(" "),a("li",[t._v("若以上條件皆符合即為優良的標註，按「是」送出。反之按「否」。")])]),t._v(" "),a("div",{staticClass:"text-h6"},[t._v("參考資料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://vision.stanford.edu/pdf/bbox_submission.pdf",target:"_blank"}},[t._v("Su, H., Deng, J., & Fei-Fei, L. (2012). Crowdsourcing annotations for visual object detection. In AAAI human computation workshop.")])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://chtseng.wordpress.com/2019/03/10/ai%e9%a0%98%e5%9f%9f%e7%9a%84%e8%97%8d%e9%a0%98%e5%b7%a5%e4%bd%9c-image-labeling/",target:"_blank"}},[t._v("AI領域的藍領工作- Image Labeling")])])])]),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1)],1)};v._withStripped=!0;var b=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tag-select"},[a("q-select",{attrs:{filled:"",dense:"","bg-color":"grey-2","use-input":"","hide-selected":"","fill-input":"","input-debounce":"0",options:t.tagArr},on:{filter:t.FilterTag,input:t.SelectTag},model:{value:t.selectTag,callback:function(e){t.selectTag=e},expression:"selectTag"}})],1)};b._withStripped=!0;const _={name:"tag-select",props:{dataset:Object},components:{},data:function(){return{tagArr:[],selectTag:""}},created:function(){},methods:{FilterTag:function(t,e,a){e(function(){this.tagArr=this.dataset.tagArr.filter(function(e){return e.indexOf(t)>-1}.bind(this))}.bind(this))},SelectTag:function(t){this.selectTag=t,this.$emit("change")}}};a(4973);const y={name:"annotator-bbox",components:{"tag-select":s(_,b,[],!1,null,null,null).exports},props:{dataset:Object,image:Object,task:String},data:function(){return{openHelp:!1,openTagSelect:!1,tool:"move",toolOption:[{value:"bbox",slot:"bbox"},{value:"move",slot:"move"}],container:null,stage:null,imageLayer:null,bboxLayer:null,imageNode:null,annotationArr:[],gesture:"",lastTouch:null,newRect:null,target:null,labelColor:{}}},mounted:function(){this.GenLabelColor(),this.InitCanvas()},methods:{GetRelativeMousePos:function(t){var e=t.getAbsoluteTransform().copy();e.invert();var a=t.getStage().getPointerPosition();return e.point(a)},HSVtoRGB:function(t,e,a,i){var n,s,o,r,l,c,d,h;switch(1===arguments.length&&(e=t.s,a=t.v,t=t.h),c=a*(1-e),d=a*(1-(l=6*t-(r=Math.floor(6*t)))*e),h=a*(1-(1-l)*e),r%6){case 0:n=a,s=h,o=c;break;case 1:n=d,s=a,o=c;break;case 2:n=c,s=a,o=h;break;case 3:n=c,s=d,o=a;break;case 4:n=h,s=c,o=a;break;case 5:n=a,s=c,o=d}return"rgba("+(n=Math.round(255*n))+","+(s=Math.round(255*s))+","+(o=Math.round(255*o))+","+i+")"},GenLabelColor:function(){this.labelColor={};for(var t=this.dataset.tagArr.length,e=.2,a=0;a<t;a++){var i=a%5*e,n=1-parseInt(a*e)%5*e,s=1-parseInt(a*e*e)%5*e,o=this.HSVtoRGB(i,n,s,1),r=s>=.5?"#000000":"#ffffff",l=this.dataset.tagArr[a];this.labelColor[l]={fg:r,bg:o}}},BoundInImage:function(t){var e=this.imageNode.absolutePosition(),a=this.imageNode.size(),i=this.imageNode.getAbsoluteScale();return t.x<e.x&&(t.x=e.x),t.x>=e.x+a.width*i.x&&(t.x=e.x+a.width*i.x),t.y<e.y&&(t.y=e.y),t.y>=e.y+a.height*i.y&&(t.y=e.y+a.height*i.y),t},BoundStage:function(t){var e=this.stage.size(),a=this.imageNode.size(),i=this.stage.scale(),n=.5*(e.width-a.width)*i.x,s=.5*(e.height-a.height)*i.y,o=.5*(e.width+a.width)*i.x,r=.5*(e.height+a.height)*i.y;return a.width*i.x>e.width?t.x+n>0?t.x=-n:t.x+o<e.width&&(t.x=e.width-o):t.x+n<0?t.x=-n:t.x+o>e.width&&(t.x=e.width-o),a.height*i.y>e.height?t.y+s>0?t.y=-s:t.y+r<e.height&&(t.y=e.height-r):t.y+s<0?t.y=-s:t.y+r>e.height&&(t.y=e.height-r),t},InitCanvas:function(){this.container="view"==this.task?this.$refs.viewCanvas:this.$refs.editCanvas,this.stage=new Konva.Stage({container:this.container,width:this.container.clientWidth,height:this.container.clientHeight,draggable:!1,dragBoundFunc:this.BoundStage}),this.stage.content.style.margin="auto",this.tool="annotate"==this.task?"bbox":"move",this.ChangeTool(),this.stage.on("wheel",function(t){t.evt.preventDefault();var e=this.stage.scaleX(),a=t.evt.deltaY>0?.95*e:e/.95;a<1&&(a=1);var i=this.stage.getPointerPosition(),n=(i.x-this.stage.x())/e,s=(i.y-this.stage.y())/e;this.stage.scale({x:a,y:a});var o={x:-n*a+i.x,y:-s*a+i.y};o=this.BoundStage(o),this.stage.position(o),this.stage.batchDraw()}.bind(this)),this.stage.on("mousedown touchstart",function(t){if("touchstart"==t.type&&2==t.evt.touches.length)this.gesture="pinch",this.lastTouch=t;else if(this.gesture="drag","bbox"==this.tool){if(""!=t.target.name())return;var e=this.GetRelativeMousePos(this.stage);e=this.BoundInImage(e),this.lastTouch=this.stage.getPointerPosition(),this.newRect&&this.newRect.destroy(),this.newRect=new Konva.Rect({x:e.x,y:e.y,width:0,height:0,fill:"rgba(0,0,0,0)",stroke:"#ffffff"}),this.bboxLayer.add(this.newRect)}this.stage.batchDraw()}.bind(this)),this.stage.on("mousemove touchmove",function(t){if("pinch"==this.gesture){var e=this.lastTouch.evt.touches[0],a=this.lastTouch.evt.touches[1],i=t.evt.touches[0],n=t.evt.touches[1];if(this.lastTouch=t,!(e&&a&&i&&n))return;function p(t,e){var a=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(a*a+i*i)}var s=p(e,a),o=p(i,n),r=this.stage.scaleX(),l=o/s;l>1.1?l=1.1:l<.9&&(l=.9);var c=r*l;c<1&&(c=1);var d={x:.5*(i.clientX+n.clientX),y:.5*(i.clientY+n.clientY)},h={x:(d.x-this.stage.x())/r,y:(d.y-this.stage.y())/r};this.stage.scale({x:c,y:c});var u={x:-h.x*c+d.x,y:-h.y*c+d.y};u=this.BoundStage(u),this.stage.position(u)}else if("drag"==this.gesture)if("bbox"==this.tool){if(!this.newRect)return;var g=this.GetRelativeMousePos(this.stage);g=this.BoundInImage(g);var m=this.newRect.position();this.newRect.setAttrs({width:g.x-m.x,height:g.y-m.y})}else if("move"==this.tool){if(g=this.stage.getPointerPosition(),!this.lastTouch)return void(this.lastTouch=g);var f=this.stage.position();u={x:f.x+g.x-this.lastTouch.x,y:f.y+g.y-this.lastTouch.y},this.lastTouch=g,u=this.BoundStage(u),this.stage.position(u)}this.stage.batchDraw()}.bind(this)),this.stage.on("mouseup touchend",function(t){if(this.lastTouch=null,"pinch"==this.gesture)this.gesture="";else if("drag"==this.gesture){if(this.gesture="","bbox"!=this.tool)return;if(!this.newRect)return;var e=this.newRect.size();if(Math.abs(e.width)<10||Math.abs(e.height)<10)return this.CancelTagSelect();this.openTagSelect=!0}}.bind(this)),this.imageLayer=new Konva.Layer,this.bboxLayer=new Konva.Layer,this.stage.add(this.imageLayer),this.stage.add(this.bboxLayer)},ChangeTool:function(){switch(this.tool){case"move":this.container.style.cursor="grab";break;case"bbox":this.container.style.cursor="default"}},ConfirmTagSelect:function(){if(this.target){var t=this.$refs.tagSelect.selectTag;if(!t||""==t)return alert("請選擇標籤");this.target.tag=t;var e=this.labelColor[t].bg,a=this.labelColor[t].fg;this.target.node.find("Rect")[0].setAttr("stroke",e);var i=this.target.node.find("Label")[0];i.getTag().setAttr("fill",e),i.getText().setAttr("fill",a).text(t),this.target=null,this.openTagSelect=!1,this.stage.batchDraw()}},CancelTagSelect:function(){this.openTagSelect=!1,this.target=null,this.newRect&&(this.newRect.destroy(),this.newRect=null),this.stage.batchDraw()},GenBBox:function(t,e,a,i,n,s){var o=new Konva.Group;this.bboxLayer.add(o);var r=new Konva.Rect({x:t,y:e,width:a,height:i,fill:"rgba(0,0,0,0)",stroke:this.labelColor[n].bg,strokeWidth:1});o.add(r);var l=new Konva.Label({});l.add(new Konva.Tag({fill:this.labelColor[n].bg})),l.add(new Konva.Text({text:n,padding:3,fontSize:10,fill:this.labelColor[n].fg,name:"BBoxLabel"})),l.on("click tap",function(t){this.openTagSelect=!0,this.target=h,Vue.nextTick(function(){this.$refs.tagSelect.selectTag=h.tag}.bind(this))}.bind(this)),l.position({x:t,y:e-l.height()}),o.add(l);var c=function(t,e,a){return function(i){a.scaleX(1.5),a.scaleY(1.5),a.y(e.y()-1.5*a.height()),a.draw(),e.strokeWidth(3),t.moveToTop()}},d=function(t,e,a){return function(t){a.scaleX(1),a.scaleY(1),a.y(e.y()-a.height()),a.draw(),e.strokeWidth(1)}};o.on("mouseover",c(o,r,l)),o.on("mouseout",d(0,r,l));var h={tag:n,x:t,y:e,width:a,height:i,node:o,index:this.annotationArr.length};if(this.annotationArr.push(h),s){var u=function(t){var e=o.find(".LT")[0],a=o.find(".RT")[0],i=o.find(".RB")[0],n=o.find(".LB")[0];switch(t.getName()){case"LT":n.x(t.x()),a.y(t.y());break;case"RT":i.x(t.x()),e.y(t.y());break;case"RB":a.x(t.x()),n.y(t.y());break;case"LB":e.x(t.x()),i.y(t.y())}for(var s=[e,a,i,n],u=Number.MAX_VALUE,g=Number.MAX_VALUE,m=Number.MIN_VALUE,f=Number.MIN_VALUE,p=0;p<s.length;p++){var v=s[p].position(),b=s[p].size(),_=v.x+.5*b.width,y=v.y+.5*b.height;_<u&&(u=_),_>m&&(m=_),y<g&&(g=y),y>f&&(f=y)}var x=m-u,k=f-g;r.setAttrs({x:u,y:g,width:x,height:k}),h.x=u,h.y=g,h.width=x,h.height=k,l.setAttrs({x:u,y:g-l.height()}),o.on("mouseover",c(o,r,l)),o.on("mouseout",d(0,r,l)),this.stage.batchDraw()}.bind(this),g=function(t,e,a,i){var n=new Konva.Rect({x:e-5,y:a-5,width:10,height:10,fill:"#ffffff",stroke:"#3333ff",name:i,draggable:!0,dragBoundFunc:function(t){return t.x+=5,t.y+=5,(t=this.BoundInImage(t)).x-=5,t.y-=5,t}.bind(this)});n.on("dragmove",function(){u(n)}.bind(this)),t.add(n)}.bind(this);g(o,t,e,"LT"),g(o,t+a,e,"RT"),g(o,t+a,e+i,"RB"),g(o,t,e+i,"LB")}},AddAnnotation:function(){if(this.newRect){var t=this.$refs.tagSelect.selectTag;if(!t||""==t)return alert("請選擇標籤");var e=this.newRect.position(),a=this.newRect.size();a.width<0&&(e.x=e.x+a.width,a.width=-a.width),a.height<0&&(e.y=e.y+a.height,a.height=-a.height),this.GenBBox(e.x,e.y,a.width,a.height,t,!0),this.openTagSelect=!1,this.newRect.destroy(),this.newRect=null,this.stage.batchDraw()}},RemoveAnnotation:function(){this.target&&(this.target.node.destroy(),this.annotationArr.splice(this.target.index,1),this.target=null,this.openTagSelect=!1,this.stage.batchDraw())},ChangeImage:function(){this.imageNode&&this.imageNode.destroy();for(var t=0;t<this.annotationArr.length;t++)this.annotationArr[t].node.destroy();this.annotationArr=[];var e=this.$refs.srcImage,a=this.container.clientWidth,i=this.container.clientHeight,n=a/e.width,s=i/e.height,o=Math.min(n,s),r=e.width*o,l=e.height*o;this.imageNode=new Konva.Image({x:.5*(a-r),y:.5*(i-l),width:r,height:l,image:e}),this.imageLayer.add(this.imageNode),"view"!=this.task&&"verify"!=this.task||this.DrawAnnotation(),this.tool="annotate"==this.task?"bbox":"move",this.ChangeTool(),this.stage.batchDraw()},DrawAnnotation:function(){if(this.image.annotation){for(var t=this.imageNode.position(),e=this.imageNode.size(),a=this.$refs.srcImage,i=0;i<this.image.annotation.annotation.length;i++){var n=this.image.annotation.annotation[i],s=parseFloat(n.x),o=parseFloat(n.y),r={x:s,y:o},l={x:s+parseFloat(n.width),y:o+parseFloat(n.height)};r.x=r.x*e.width/a.width+t.x,r.y=r.y*e.height/a.height+t.y,l.x=l.x*e.width/a.width+t.x,l.y=l.y*e.height/a.height+t.y,this.GenBBox(r.x,r.y,l.x-r.x,l.y-r.y,n.tag,!1)}this.stage.batchDraw()}},SetAnnotation:function(){if(0==this.annotationArr.length)return alert("請至少新增一個標籤");this.$emit("setAnnotation")},SetVerification:function(t){this.$emit("setVerification",t)},GetAnnotation:function(){for(var t=[],e=this.imageNode.position(),a=this.imageNode.size(),i=this.$refs.srcImage,n=0;n<this.annotationArr.length;n++){var s=this.annotationArr[n],o={},r={x:s.x,y:s.y},l={x:s.x+s.width,y:s.y+s.height};r.x=(r.x-e.x)*i.width/a.width,r.y=(r.y-e.y)*i.height/a.height,l.x=(l.x-e.x)*i.width/a.width,l.y=(l.y-e.y)*i.height/a.height,o.x=r.x,o.y=r.y,o.width=l.x-r.x,o.height=l.y-r.y,o.tag=s.tag,t.push(o)}return t},SkipTask:function(){this.$emit("skipTask")}}};a(1255);const x=s(y,v,[],!1,null,null,null).exports,k={name:"annotator",components:{"dataset-select":h,"annotator-image":p,"annotator-bbox":x},props:{user:Object,dataset:Object,image:Object,autoTask:Boolean},data:function(){return{datasetSelect:null,imageSelect:null,taskSelect:"",openDatasetSelect:!1,imageArr:[],status:"",verify:null}},mounted:function(){this.user||(window.location.href="/login?intentUrl="+encodeURIComponent(window.location.pathname+window.location.search)),this.datasetSelect=this.dataset,this.imageSelect=this.image,this.dataset?this.GenerateTask():(this.status="請選擇資料集",this.openDatasetSelect=!0)},methods:{ChangeDataset:function(){this.openDatasetSelect=!1,this.datasetSelect=this.$refs.datasetSelect.GetSelectDataset();var t="/dataset/list-image-for-annotation";t+="?dataset="+this.datasetSelect._id,$.get(t,function(t){if("ok"==t.status){for(var e=0;e<t.data.length;e++){var a=t.data[e];a.url="/static/upload/dataset/"+this.datasetSelect._id+"/image/"+a._id+".jpg"}this.imageArr=t.data,this.GenerateTask()}}.bind(this))},GenerateTask:function(){if(this.imageSelect=null,this.datasetSelect){if(this.image){if(this.image.annotation&&this.image.verification.filter(function(t){return t.user==this.user._id}.bind(this)).length>0)return void(this.status="您已驗證過此影像，感謝您的協助");this.imageSelect=this.image}else{if(0==this.imageArr.length)return void(this.status="此資料集影像皆已標註完成");for(var t=[],e=0;e<this.imageArr.length;e++){var a=this.imageArr[e];a.annotation?0==a.verification.filter(function(t){return t.user==this.user._id}.bind(this)).length&&t.push(a):t.push(a)}if(0==t.length)return void(this.status="您已驗證過此資料集所有資料，感謝您的協助");var i=function(){if(0==t.length)return null;var e=Math.floor(Math.random()*t.length);return t[e]}.bind(this);this.imageSelect=i()}var n=function(){this.imageSelect.annotation?this.imageSelect.verifyNum<this.verify.sample?this.taskSelect="verify":this.imageSelect.agreeNum<this.imageSelect.verifyNum*this.verify.reject?this.taskSelect="annotate":this.taskSelect="verify":this.taskSelect="annotate"}.bind(this);this.verify?n():$.get("/dataset/verify-condition",function(t){if("ok"!=t.status)return alert("讀取驗證條件失敗");this.verify=t.data,n()}.bind(this))}else this.status="請選擇資料集"},GetAnnotator:function(){if(!this.datasetSelect)return null;var t=null;switch(this.datasetSelect.annotationType){case"image":t=this.$refs.annotatorImage;break;case"bbox":t=this.$refs.annotatorBBox}return t},UploadAnnotation:function(){var t=this.GetAnnotator();if(t){var e=$("meta[name='csrf-token']").attr("content"),a={};a.dataset=t.dataset._id,a.image=t.image._id,a.annotation=t.GetAnnotation(),a._csrf=e,$.post("/dataset/set-annotation",a,function(t){if("ok"!=t.status)return"blacklist"===t.message?alert("黑名單使用者無此權限"):alert("標註失敗");this.imageSelect.annotation={user:this.user._id,annotation:a.annotation},this.$q.notify("標註成功"),this.autoTask?this.GenerateTask():this.$emit("done")}.bind(this))}},UploadVerification:function(t){var e=this.GetAnnotator();if(e){var a=$("meta[name='csrf-token']").attr("content"),i={};i.dataset=e.dataset._id,i.image=e.image._id,i.agree=t?"1":"0",i._csrf=a,$.post("/dataset/add-verification",i,function(t){if("ok"!=t.status)switch(t.message){case"verification duplicate":this.$q.notify("您之前已驗證過這個標註");break;case"blacklist":alert("黑名單使用者無此權限");break;default:alert("驗證失敗")}else this.$q.notify("驗證成功");this.imageSelect.verification.push({user:this.user._id,agree:i.agree}),this.autoTask?this.GenerateTask():this.$emit("done")}.bind(this))}},OpenHelp:function(){var t=this.GetAnnotator();t&&(t.openHelp=!0)},SkipTask:function(){this.autoTask?this.GenerateTask():this.$emit("skip")}}},w=k;a(9481);const S=s(w,l,[],!1,null,null,null).exports;var C=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator-view bg-grey-7"},[t.dataset&&t.image?a("div",{staticClass:"fit"},["image"==t.dataset.annotationType?a("annotator-image",{attrs:{dataset:t.dataset,image:t.image,task:"view"}}):t._e(),t._v(" "),"bbox"==t.dataset.annotationType?a("annotator-bbox",{attrs:{dataset:t.dataset,image:t.image,task:"view"}}):t._e()],1):a("div",{staticClass:"fit row justify-center items-center"},[a("div",{staticClass:"text-h5 text-white"},[t._v("無影像")])])])};C._withStripped=!0;const q={name:"annotator-view",components:{"annotator-image":p,"annotator-bbox":x},props:{dataset:Object,image:Object},data:function(){return{}},mounted:function(){},methods:{}};a(2083);const T=s(q,C,[],!1,null,null,null).exports;var I=function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"location-select"},[e("div",{ref:"map",staticClass:"map"})])};I._withStripped=!0;const A={name:"location-select",props:{mode:String},components:{},data:function(){return{loc:null,status:"",OnGPSReady:null,map:null,locMarker:null,rangeMarker:null,range:10}},mounted:function(){this.InitMap()},methods:{InitMap:function(){switch(this.map=L.map(this.$refs.map).setView([23.682094,120.7764642],7),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'<a href="https://www.openstreetmap.org/">OSM</a>',maxZoom:18}).addTo(this.map),this.mode){case"selectLoc":this.map.on("click",function(t){var e=t.latlng;this.SetPosition(e.lat,e.lng)}.bind(this));break;case"selectRange":this.map.on("click",function(t){var e=t.latlng;this.SetRange(e.lat,e.lng,this.range)}.bind(this))}},SetPosition:function(t,e,a){t&&e&&(this.loc={lat:t,lng:e},this.status="座標: "+t.toFixed(5)+" "+e.toFixed(5),this.locMarker?this.locMarker.setLatLng(this.loc,{draggable:"selectLoc"==this.mode}).bindPopup(this.status).update():(this.locMarker=L.marker(this.loc,{draggable:"selectLoc"==this.mode}),this.locMarker.on("dragend",function(t){var e=this.locMarker.getLatLng();this.SetPosition(e.lat,e.lng)}.bind(this)),this.locMarker.addTo(this.map)),a&&this.map.setView([t,e],12),this.$emit("change"))},SetRange:function(t,e,a){t&&e&&(this.range=a,this.loc={lat:t,lng:e},this.status="座標: "+t.toFixed(5)+" "+e.toFixed(5),this.rangeMarker?(this.rangeMarker.setLatLng(this.loc),this.rangeMarker.setRadius(1e3*this.range)):(this.rangeMarker=L.circle(this.loc,{weight:1,color:"#ff0000",fillColor:"#ff3333",fillOpacity:.3,radius:1e3*this.range}),this.rangeMarker.addTo(this.map)),this.locMarker?this.locMarker.setLatLng(this.loc,{draggable:"selectRange"==this.mode}).bindPopup(this.status).update():(this.locMarker=L.marker(this.loc,{draggable:"selectRange"==this.mode}),this.locMarker.on("drag",function(t){var e=t.target.getLatLng();this.rangeMarker.setLatLng(e)}.bind(this)),this.locMarker.on("dragend",function(t){var e=this.locMarker.getLatLng();this.rangeMarker.setLatLng(e),this.loc={lat:e.lat,lng:e.lng},this.$emit("change")}.bind(this)),this.locMarker.addTo(this.map)),this.$emit("change"))},GetGPS:function(){this.status="無GPS-請點選位置",navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){switch(this.map.setView([t.coords.latitude,t.coords.longitude],12),this.mode){case"selectLoc":this.SetPosition(t.coords.latitude,t.coords.longitude);break;case"selectRange":this.SetRange(t.coords.latitude,t.coords.longitude,this.range)}this.OnGPSReady&&this.OnGPSReady()}.bind(this),function(t){this.status="讀取GPS失敗-請點選位置"}.bind(this)):this.status="瀏覽器不支援GPS-請點選位置"},RemoveMarker:function(){this.locMarker&&(this.map.removeLayer(this.locMarker),this.locMarker=null),this.rangeMarker&&(this.map.removeLayer(this.rangeMarker),this.rangeMarker=null)}}};a(5904);const R=s(A,I,[],!1,null,null,null).exports;var M=function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.dataset?a("q-card",{staticClass:"image-info full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇資料時間")]),t._v(" "),a("input",{directives:[{name:"model",rawName:"v-model",value:t.dataTime,expression:"dataTime"}],staticClass:"q-pa-sm",attrs:{type:"datetime-local"},domProps:{value:t.dataTime},on:{change:function(e){return t.$emit("change")},input:function(e){e.target.composing||(t.dataTime=e.target.value)}}})]),t._v(" "),t.dataset.enableGPS?a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇資料地點")]),t._v(" "),a("location-select",{ref:"locationSelect",attrs:{mode:"selectLoc"}}),t._v(" "),t.$refs.locationSelect?a("div",{staticClass:"text-center"},[t._v(t._s(t.$refs.locationSelect.status))]):t._e()],1):t._e(),t._v(" "),t.dataset.form?a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("填寫表單")]),t._v(" "),a("form-reply",{ref:"formReply",attrs:{formData:t.dataset.form,formReply:t.initReply}})],1):t._e(),t._v(" "),a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("資料備註說明(若無備註說明請直接按確定)")]),t._v(" "),a("q-input",{attrs:{filled:"",type:"textarea"},on:{input:function(e){return t.$emit("change")}},model:{value:t.remark,callback:function(e){t.remark=e},expression:"remark"}})],1),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{attrs:{flat:"",label:"確定"},on:{click:function(e){return t.ConfirmSelect()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"取消"},on:{click:function(e){return t.CancelSelect()}}})],1)],1):t._e()};M._withStripped=!0;var D=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"form-reply"},[a("q-list",{attrs:{bordered:""}},t._l(t.formData.itemArr,(function(e,i){return a("q-item",{key:e.id},[a("q-item-section",[a("div",["true"==e.canNotEmpty?a("span",{staticClass:"text-red"},[t._v("*")]):t._e(),t._v("\n\t\t\t\t\t"+t._s(i+1)+". "+t._s(e.quest)+"\n\t\t\t\t")]),t._v(" "),a("div",["text"==e.type?a("div",[a("q-input",{ref:e.id,refInFor:!0,attrs:{dense:"",placeholder:"請輸入文字",rules:e.rule},model:{value:t.editReply[e.id].value,callback:function(a){t.$set(t.editReply[e.id],"value",a)},expression:"editReply[item.id].value"}})],1):t._e(),t._v(" "),"radio"==e.type?a("div",t._l(e.option,(function(i,n){return a("q-radio",{key:i,attrs:{label:i,val:i},model:{value:t.editReply[e.id].value,callback:function(a){t.$set(t.editReply[e.id],"value",a)},expression:"editReply[item.id].value"}})})),1):t._e(),t._v(" "),"checkbox"==e.type?a("div",[a("div",{staticClass:"text-subtitle2 text-red row"},[e.attr.minCheck?a("div",{staticClass:"q-mx-sm"},[t._v("最少選"+t._s(e.attr.minCheck)+"項")]):t._e(),t._v(" "),e.attr.maxCheck?a("div",{staticClass:"q-mx-sm"},[t._v("最多選"+t._s(e.attr.maxCheck)+"項")]):t._e()]),t._v(" "),t._l(e.option,(function(i,n){return a("q-checkbox",{key:i,attrs:{label:i,val:i},model:{value:t.editReply[e.id].value,callback:function(a){t.$set(t.editReply[e.id],"value",a)},expression:"editReply[item.id].value"}})}))],2):t._e(),t._v(" "),"number"==e.type?a("div",[a("div",{staticClass:"text-subtitle2 text-red row"},[e.attr.minValue?a("div",{staticClass:"q-mx-sm"},[t._v("最小數值"+t._s(e.attr.minValue))]):t._e(),t._v(" "),e.attr.maxValue?a("div",{staticClass:"q-mx-sm"},[t._v("最大數值"+t._s(e.attr.maxValue))]):t._e()]),t._v(" "),a("q-input",{ref:e.id,refInFor:!0,attrs:{type:"number",dense:"",placeholder:"請輸入數字",rules:e.rule},model:{value:t.editReply[e.id].value,callback:function(a){t.$set(t.editReply[e.id],"value",a)},expression:"editReply[item.id].value"}})],1):t._e()])])],1)})),1)],1)};D._withStripped=!0;const N={name:"form-editor",props:{formData:Object,formReply:Object},components:{},data:function(){return{editReply:{}}},created:function(){if(this.formReply)this.editReply=Object.assign({},this.formReply);else{for(var t={},e=0;e<this.formData.itemArr.length;e++){var a={};"checkbox"==(i=this.formData.itemArr[e]).type&&(a.value=[]),t[i.id]=a}this.editReply=t}for(e=0;e<this.formData.itemArr.length;e++){var i;switch((i=this.formData.itemArr[e]).attr||(i.attr={}),i.option||(i.option=[]),this.editReply[i.id]||(a={},"checkbox"==i.type&&(a.value=[]),Vue.set(this.editReply,i.id,a)),i.rule=[],i.type){case"text":"true"==i.canNotEmpty&&i.rule.push((t=>!!t||"文字不能空白"));break;case"number":i.rule.push(function(){var t=parseFloat(i.attr.minValue),e=parseFloat(i.attr.maxValue),a="true"==i.canNotEmpty;return function(i){return a&&null==i?"數字不能空白":NaN!=t&&i<t?"數值不能小於"+t:!(NaN!=e&&i>e)||"數值不能大於"+e}}())}}},methods:{ValidateReply:function(){for(var t=!0,e=0;e<this.formData.itemArr.length;e++){var a=this.formData.itemArr[e],i=this.editReply[a.id].value;switch(a.type){case"text":case"number":var n=this.$refs[a.id][0];n.validate(),n.hasError&&(this.$q.notify({color:"negative",message:"欄位"+(e+1)+" 格式不符"}),t=!1);break;case"radio":"true"==a.canNotEmpty&&null==i&&(this.$q.notify({color:"negative",message:"欄位"+(e+1)+" 不能空白"}),t=!1);break;case"checkbox":if(i||(i=[]),"true"!=a.canNotEmpty||i.length||(this.$q.notify({color:"negative",message:"欄位"+(e+1)+" 不能空白"}),t=!1),i.length>0){var s=parseFloat(a.attr.minCheck),o=parseFloat(a.attr.maxCheck);(NaN!=s&&i.length<s||NaN!=o&&i.length>o)&&(this.$q.notify({color:"negative",message:"欄位"+(e+1)+" 選擇數量不符規定"}),t=!1)}}}return t}}};a(6044);const G=s(N,D,[],!1,null,null,null).exports,j={name:"image-info",props:{dataset:Object,initDataTime:String,initLat:Number,initLng:Number,initRemark:String,initReply:Object},components:{"location-select":R,"form-reply":G},data:function(){return{dataTime:null,remark:""}},mounted:function(){var t=spacetime().name;this.initDataTime?this.dataTime=spacetime(this.initDataTime).goto(t).unixFmt("yyyy-MM-ddTHH:mm"):this.dataTime=spacetime.now().unixFmt("yyyy-MM-ddTHH:mm"),this.$refs.locationSelect&&(this.initLat&&this.initLng?this.$refs.locationSelect.SetPosition(this.initLat,this.initLng,!0):this.dataset.enableGPS&&this.$refs.locationSelect.GetGPS()),this.initRemark&&(this.remark=this.initRemark)},methods:{GetImageInfo:function(){var t={},e=spacetime.now();return t.dataTime=spacetime(this.dataTime,e.timezone().name).format("iso"),t.remark=this.remark,this.$refs.formReply&&(t.formReply=this.$refs.formReply.editReply),this.$refs.locationSelect&&(t.loc=this.$refs.locationSelect.loc),t},ConfirmSelect:function(){var t=this.$refs.formReply;t&&!t.ValidateReply()||this.$emit("confirm")},CancelSelect:function(){this.$emit("cancel")}}};a(2155);const V=s(j,M,[],!1,null,null,null).exports,E={name:"image-control",props:{user:Object,dataset:Object,image:Object,showNavigate:Boolean,editable:Boolean},components:{annotator:S,"annotator-view":T,"location-select":R,"image-info":V},data:function(){return{openAnnotator:!1,openLocationView:!1,openInfoEdit:!1,editImage:null,uploader:null,annotator:null,openUserInfo:!1,targetUser:null}},mounted:function(){this.UpdateContributer()},methods:{GoToPrev:function(){this.$emit("goToPrev")},GoToNext:function(){this.$emit("goToNext")},CloseView:function(){this.$emit("closeView")},AnnotateImage:function(){this.openAnnotator=!0},FinishAnnotation:function(){this.openAnnotator=!1,this.openViewImage=!1,this.$emit("reload")},ViewLocation:function(){this.openLocationView=!0,Vue.nextTick(function(){this.$refs.locationSelect.SetPosition(this.image.lat,this.image.lng,!0)}.bind(this))},OpenInfoEditor:function(){$.get("/dataset/view-image?dataset="+this.dataset._id+"&image="+this.image._id,function(t){if("ok"!=t.status)return window.location.href="/?message="+encodeURIComponent("無法顯示影像");var e=spacetime().name;if(this.editImage=t.data,this.editImage.dataTime){var a=spacetime(this.editImage.dataTime).goto(e);this.editImage.time=a.unixFmt("yyyy-MM-dd HH:mm:ss")}this.editImage.url="/static/upload/dataset/"+this.dataset._id+"/image/"+this.image._id+".jpg",this.openInfoEdit=!0}.bind(this))},OpenUserInfo:function(t){this.targetUser=t,this.openUserInfo=!0},UpdateContributer:function(){Vue.nextTick(function(){this.uploader=null,this.annotator=null;var t=[],e="user"==this.image.uploadFrom&&this.image.uploader,a=this.image.annotation&&this.image.annotation.user;e&&t.push(this.image.uploader),a&&t.push(this.image.annotation.user),0!=t.length&&$.get("/user/list-name?id="+t.join(),function(t){if("ok"!=t.status)return alert("取得貢獻者資料失敗");for(var i={},n=0;n<t.data.length;n++){var s=t.data[n];i[s._id]=s}e&&(this.uploader=i[this.image.uploader]),a&&(this.annotator=i[this.image.annotation.user])}.bind(this))}.bind(this))},UpdateImageInfo:function(){var t=$("meta[name='csrf-token']").attr("content"),e=this.$refs.imageInfo.GetImageInfo(),a={};a.dataset=this.dataset._id,a.image=this.image._id,a.dataTime=e.dataTime,a.remark=e.remark,a.formReply=e.formReply,e.loc&&(a.lat=e.loc.lat,a.lng=e.loc.lng),a._csrf=t,$.post("/dataset/update-image-info",a,function(t){if("ok"!=t.status)return alert("更新失敗");this.$emit("reload"),this.openInfoEdit=!1,this.$q.notify("更新成功")}.bind(this))},DeleteImage:function(){if(confirm("確定刪除此影像?")){var t=$("meta[name='csrf-token']").attr("content"),e={};e.dataset=this.dataset._id,e.image=this.image._id,e._csrf=t,$.post("/dataset/delete-image",e,function(t){if("ok"!=t.status)return alert("刪除失敗");this.$emit("reload"),this.$q.notify("刪除成功")}.bind(this))}},DownloadImage:function(){if(this.image){var t=$("<a>").attr("href",this.image.url).attr("download",this.image._id+".jpg").appendTo("body");t[0].click(),t.remove()}},GoToExternalLink:function(){var t=spacetime.now(),e=spacetime(this.image.dataTime).goto(t.timezone().name);switch(e=e.subtract(e.minute()%10,"minute"),this.dataset.externalLink){case"riverlog":var a="https://riverlog.lass-net.org/";a+="#year="+e.year(),a+="&date="+e.unixFmt("MM-dd"),a+="&time="+e.unixFmt("HH:mm"),a+="&lat="+this.image.lat,a+="&lng="+this.image.lng,a+="&marker="+this.image.lat+","+this.image.lng,a+="&zoom=16",window.open(a,"_blank");break;case"purbao":a="https://purbao.lass-net.org/",a+="?year="+e.year(),a+="&date="+e.unixFmt("M/d"),a+="&lat="+this.image.lat,a+="&lng="+this.image.lng,a+="&marker="+this.image.lat+","+this.image.lng,a+="&zoom=16",window.open(a,"_blank")}},GoToImageUrl:function(){this.image&&window.open("/image?dataset="+this.dataset._id+"&image="+this.image._id,"_blank")},DeleteAnnotation:function(){if(confirm("確定刪除此影像的標註?")){this.openViewImage=!1;var t=$("meta[name='csrf-token']").attr("content"),e={};e.dataset=this.dataset._id,e.image=this.image._id,e._csrf=t,$.post("/dataset/set-annotation",e,function(t){if("ok"!=t.status)return alert("刪除標註失敗");this.$q.notify("刪除標註成功"),this.$emit("reload")}.bind(this))}}},computed:{AgreeVerifyRatio:function(){var t=this.image.agreeNum+" / "+this.image.verifyNum;return this.image.verifyNum>0&&(t+=" ("+(100*this.image.agreeNum/this.image.verifyNum).toFixed(0)+"%)"),t},CheckAnnotationDelete:function(){return!!this.user&&!!this.image&&!!this.image.annotation&&("admin"==this.user.authType||this.image.annotation.user==this.user._id||!!this.dataset&&this.dataset.master.filter(function(t){return t._id==this.user._id}.bind(this)).length>0)},CheckEditAuth:function(){return!!this.user&&("admin"==this.user.authType||this.image.uploader==this.user._id||!!this.dataset&&this.dataset.master.filter(function(t){return t._id==this.user._id}.bind(this)).length>0)}}};a(8029);const O={name:"image-view",components:{topbar:o,"image-control":s(E,r,[],!1,null,null,null).exports},data:function(){return{user:null,datasetID:null,imageID:null,dataset:null,image:null}},created:function(){var t=e();this.datasetID=t.dataset,this.imageID=t.image,$.get("/user/info",function(t){"ok"==t.status&&(this.user=t.data)}.bind(this)),$.get("/dataset/view-dataset?id="+this.datasetID,function(t){if("ok"!=t.status)return window.location.href="/?message="+encodeURIComponent("無法顯示資料集");this.dataset=t.data,$.get("/dataset/view-image?dataset="+this.datasetID+"&image="+this.imageID,function(t){if("ok"!=t.status)return window.location.href="/?message="+encodeURIComponent("無法顯示影像");var e=spacetime().name;if(this.image=t.data,this.image.dataTime){var a=spacetime(this.image.dataTime).goto(e);this.image.time=a.unixFmt("yyyy-MM-dd HH:mm:ss")}this.image.url="/static/upload/dataset/"+this.datasetID+"/image/"+this.imageID+".jpg"}.bind(this))}.bind(this))},methods:{GoToDataset:function(){window.location.href="/dataset?id="+this.datasetID}}};a(4280);const U=s(O,t,[],!1,null,null,null).exports;new Vue({el:"#imageViewApp",components:{"image-view":U}})})()})();