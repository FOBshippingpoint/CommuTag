!function(t){var e={};function a(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=t,a.c=e,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)a.d(i,n,function(e){return t[e]}.bind(null,n));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="/dist/production",a(a.s=111)}([function(t,e,a){"use strict";function i(t,e,a,i,n,s,o,r){var l,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=a,c._compiled=!0),i&&(c.functional=!0),s&&(c._scopeId="data-v-"+s),o?(l=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),n&&n.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(o)},c._ssrRegister=l):n&&(l=r?function(){n.call(this,this.$root.$options.shadowRoot)}:n),l)if(c.functional){c._injectStyles=l;var h=c.render;c.render=function(t,e){return l.call(e),h(t,e)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,l):[l]}return{exports:t,options:c}}a.d(e,"a",(function(){return i}))},function(t,e,a){"use strict";var i,n=function(){return void 0===i&&(i=Boolean(window&&document&&document.all&&!window.atob)),i},s=function(){var t={};return function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(t){a=null}t[e]=a}return t[e]}}(),o={};function r(t,e,a){for(var i=0;i<e.length;i++){var n={css:e[i][1],media:e[i][2],sourceMap:e[i][3]};o[t][i]?o[t][i](n):o[t].push(m(n,a))}}function l(t){var e=document.createElement("style"),i=t.attributes||{};if(void 0===i.nonce){var n=a.nc;n&&(i.nonce=n)}if(Object.keys(i).forEach((function(t){e.setAttribute(t,i[t])})),"function"==typeof t.insert)t.insert(e);else{var o=s(t.insert||"head");if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(e)}return e}var c,h=(c=[],function(t,e){return c[t]=e,c.filter(Boolean).join("\n")});function u(t,e,a,i){var n=a?"":i.css;if(t.styleSheet)t.styleSheet.cssText=h(e,n);else{var s=document.createTextNode(n),o=t.childNodes;o[e]&&t.removeChild(o[e]),o.length?t.insertBefore(s,o[e]):t.appendChild(s)}}function d(t,e,a){var i=a.css,n=a.media,s=a.sourceMap;if(n?t.setAttribute("media",n):t.removeAttribute("media"),s&&btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleSheet)t.styleSheet.cssText=i;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(i))}}var g=null,f=0;function m(t,e){var a,i,n;if(e.singleton){var s=f++;a=g||(g=l(e)),i=u.bind(null,a,s,!1),n=u.bind(null,a,s,!0)}else a=l(e),i=d.bind(null,a,e),n=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(a)};return i(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;i(t=e)}else n()}}t.exports=function(t,e,a){return(a=a||{}).singleton||"boolean"==typeof a.singleton||(a.singleton=n()),t=a.base?t+a.base:t,e=e||[],o[t]||(o[t]=[]),r(t,e,a),function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){o[t]||(o[t]=[]),r(t,e,a);for(var i=e.length;i<o[t].length;i++)o[t][i]();o[t].length=e.length,0===o[t].length&&delete o[t]}}}},function(t,e,a){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var a=function(t,e){var a=t[1]||"",i=t[3];if(!i)return a;if(e&&"function"==typeof btoa){var n=(o=i,r=btoa(unescape(encodeURIComponent(JSON.stringify(o)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),"/*# ".concat(l," */")),s=i.sources.map((function(t){return"/*# sourceURL=".concat(i.sourceRoot||"").concat(t," */")}));return[a].concat(s).concat([n]).join("\n")}var o,r,l;return[a].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(a,"}"):a})).join("")},e.i=function(t,a){"string"==typeof t&&(t=[[null,t,""]]);for(var i=0;i<t.length;i++){var n=[].concat(t[i]);a&&(n[2]?n[2]="".concat(a," and ").concat(n[2]):n[2]=a),e.push(n)}},e}},function(t,e,a){"use strict";var i={GetUrlParameter:function(){for(var t=window.location.search.substring(1).split("&"),e={},a=0;a<t.length;a++){var i=t[a].split("=");e[i[0]]=i[1]}return e},GetUrlHash:function(){for(var t=window.location.hash.substr(1).split("&"),e={},a=0;a<t.length;a++){var i=t[a].split("=");e[i[0]]=i[1]}return e},ValidateEmail:function(t){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)},PadLeft:function(t,e,a){var i=e-String(t).length+1;return i>0?new Array(i).join(a||"0")+t:t}};e.a=i},function(t,e,a){var i=a(1),n=a(29);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(39);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){"use strict";var i=function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"location-select"},[e("div",{ref:"map",staticClass:"map"})])};i._withStripped=!0;var n={name:"location-select",props:{mode:String,initLoc:Object},components:{},data:function(){return{loc:null,status:"",OnGPSReady:null,map:null,locMarker:null,rangeMarker:null,range:10}},mounted:function(){this.InitMap()},methods:{InitMap:function(){switch(this.map=L.map(this.$refs.map).setView([23.682094,120.7764642],7),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'<a href="https://www.openstreetmap.org/">OSM</a>',maxZoom:18}).addTo(this.map),this.mode){case"selectLoc":this.map.on("click",function(t){var e=t.latlng;this.SetPosition(e.lat,e.lng)}.bind(this));break;case"selectRange":this.map.on("click",function(t){var e=t.latlng;this.SetRange(e.lat,e.lng,this.range)}.bind(this))}},SetPosition:function(t,e){t&&e&&(this.loc={lat:t,lng:e},this.status="座標: "+t.toFixed(5)+" "+e.toFixed(5),this.locMarker?this.locMarker.setLatLng(this.loc,{draggable:"selectLoc"==this.mode}).bindPopup(this.status).update():(this.locMarker=L.marker(this.loc,{draggable:"selectLoc"==this.mode}),this.locMarker.on("dragend",function(t){var e=this.locMarker.getLatLng();this.SetPosition(e.lat,e.lng)}.bind(this)),this.locMarker.addTo(this.map)),this.$emit("change"))},SetRange:function(t,e,a){t&&e&&(this.range=a,this.loc={lat:t,lng:e},this.status="座標: "+t.toFixed(5)+" "+e.toFixed(5),this.rangeMarker?(this.rangeMarker.setLatLng(this.loc),this.rangeMarker.setRadius(1e3*this.range)):(this.rangeMarker=L.circle(this.loc,{weight:1,color:"#ff0000",fillColor:"#ff3333",fillOpacity:.3,radius:1e3*this.range}),this.rangeMarker.addTo(this.map)),this.locMarker?this.locMarker.setLatLng(this.loc,{draggable:"selectRange"==this.mode}).bindPopup(this.status).update():(this.locMarker=L.marker(this.loc,{draggable:"selectRange"==this.mode}),this.locMarker.on("drag",function(t){var e=t.target.getLatLng();this.rangeMarker.setLatLng(e)}.bind(this)),this.locMarker.on("dragend",function(t){var e=this.locMarker.getLatLng();this.rangeMarker.setLatLng(e),this.loc={lat:e.lat,lng:e.lng},this.$emit("change")}.bind(this)),this.locMarker.addTo(this.map)),this.$emit("change"))},GetGPS:function(){this.status="無GPS-請點選位置",navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){switch(this.mode){case"selectLoc":this.SetPosition(t.coords.latitude,t.coords.longitude);break;case"selectRange":this.SetRange(t.coords.latitude,t.coords.longitude,this.range)}this.OnGPSReady&&this.OnGPSReady()}.bind(this),function(t){this.status="讀取GPS失敗-請點選位置"}.bind(this)):this.status="瀏覽器不支援GPS-請點選位置"},RemoveMarker:function(){this.locMarker&&(this.map.removeLayer(this.locMarker),this.locMarker=null),this.rangeMarker&&(this.map.removeLayer(this.rangeMarker),this.rangeMarker=null)}}},s=(a(38),a(0)),o=Object(s.a)(n,i,[],!1,null,null,null);o.options.__file="src/vue/location-select.vue";e.a=o.exports},,,,,function(t,e,a){var i=a(1),n=a(49);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(51);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(53);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(55);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(57);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(59);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"topbar bg-grey-8 text-white"},[a("q-toolbar",{staticClass:"q-px-md",attrs:{square:""}},[t.useMenu?a("q-btn",{attrs:{flat:"",round:"",icon:"menu"},on:{click:function(e){return t.ToggleMenu()}}}):t._e(),t._v(" "),a("a",{attrs:{href:"/"}},[a("q-btn",{attrs:{flat:"","no-caps":""}},[a("q-avatar",{attrs:{size:"md",square:""}},[a("img",{attrs:{src:t.logo}})]),t._v(" "),a("div",{staticClass:"gt-xs q-px-md text-white text-h5 inline"},[t._v(t._s(t.title))])],1)],1),t._v(" "),a("q-space"),t._v(" "),t.user?a("q-item",{attrs:{clickable:"",tag:"a",href:"/account"}},[a("q-avatar",{attrs:{size:"lg"}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:t.user.icon}})]),t._v(" "),a("q-item-section",{staticClass:"q-px-sm"},[a("q-item-label",{staticClass:"text-h6"},[t._v(t._s(t.user.name))])],1)],1):a("q-item",{attrs:{clickable:"",tag:"a",href:"/login"}},[a("q-icon",{attrs:{size:"md",name:"account_box"}}),t._v(" "),a("q-item-section",[a("q-item-label",{staticClass:"text-h6"},[t._v("登入")])],1)],1)],1)],1)};i._withStripped=!0;var n={name:"topbar",props:{user:Object,useMenu:Boolean},data:function(){return{title:"",logo:"/static/image/logo.png"}},created:function(){$.get("/site-info",function(t){"ok"==t.status&&(this.title=t.data.title,this.logo=t.data.logo)}.bind(this))},methods:{ToggleMenu:function(){this.$emit("toggleMenu")}}},s=(a(28),a(0)),o=Object(s.a)(n,i,[],!1,null,null,null);o.options.__file="src/vue/topbar.vue";e.a=o.exports},function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tag-select"},[a("q-select",{attrs:{filled:"",dense:"","bg-color":"grey-2","use-input":"","hide-selected":"","fill-input":"","input-debounce":"0",options:t.tagArr},on:{filter:t.FilterTag,input:t.SelectTag},model:{value:t.selectTag,callback:function(e){t.selectTag=e},expression:"selectTag"}})],1)};i._withStripped=!0;var n={name:"tag-select",props:{dataset:Object},components:{},data:function(){return{tagArr:[],selectTag:""}},created:function(){},methods:{FilterTag:function(t,e,a){e(function(){this.tagArr=this.dataset.tagArr.filter(function(e){return e.indexOf(t)>-1}.bind(this))}.bind(this))},SelectTag:function(t){this.selectTag=t,this.$emit("change")}}},s=(a(52),a(0)),o=Object(s.a)(n,i,[],!1,null,null,null);o.options.__file="src/vue/tag-select.vue";e.a=o.exports},,function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator-bbox"},[a("img",{ref:"srcImage",staticClass:"hidden",attrs:{src:t.image.url},on:{load:t.ChangeImage}}),t._v(" "),"view"==t.task?a("div",{staticClass:"column fit"},[a("div",{ref:"viewCanvas",staticClass:"col"})]):a("div",{staticClass:"column fit"},[a("div",{staticClass:"col q-ma-auto relative-position"},[a("div",{ref:"editCanvas",staticClass:"fit"}),t._v(" "),"annotate"==t.task?a("div",{staticClass:"tool-set"},[a("q-btn-toggle",{attrs:{glossy:"",size:"sm",options:t.toolOption,color:"grey-1","text-color":"grey-6"},on:{input:function(e){return t.ChangeTool()}},scopedSlots:t._u([{key:"bbox",fn:function(){return[a("q-icon",{attrs:{name:"aspect_ratio"}})]},proxy:!0},{key:"move",fn:function(){return[a("q-icon",{attrs:{name:"pan_tool"}})]},proxy:!0}],null,!1,1866943705),model:{value:t.tool,callback:function(e){t.tool=e},expression:"tool"}})],1):t._e()]),t._v(" "),"annotate"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"確定"},on:{click:function(e){return t.SetAnnotation()}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,2135591169)},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t請框選出影像中的物件並給予標籤\n\t\t\t")])]):t._e(),t._v(" "),"verify"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"是"},on:{click:function(e){return t.SetVerification(!0)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"否"},on:{click:function(e){return t.SetVerification(!1)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,767176183)},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t請驗證此影像框選的物件及標籤是否正確?\n\t\t\t")])]):t._e()],1),t._v(" "),a("q-dialog",{attrs:{persistent:""},model:{value:t.openTagSelect,callback:function(e){t.openTagSelect=e},expression:"openTagSelect"}},[a("q-card",[a("q-card-section",[a("div",{staticClass:"text-h6 q-py-sm"},[t._v("請選擇標籤")]),t._v(" "),a("tag-select",{ref:"tagSelect",attrs:{dataset:t.dataset}})],1),t._v(" "),a("q-separator"),t._v(" "),a("q-card-actions",{attrs:{align:"around"}},[t.newRect?a("q-btn",{attrs:{flat:"",label:"新增"},on:{click:function(e){return t.AddAnnotation()}}}):a("q-btn",{attrs:{flat:"",label:"修改"},on:{click:function(e){return t.ConfirmTagSelect()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"取消"},on:{click:function(e){return t.CancelTagSelect()}}}),t._v(" "),t.target?a("q-btn",{attrs:{flat:"",label:"刪除"},on:{click:function(e){return t.RemoveAnnotation()}}}):t._e()],1)],1)],1),t._v(" "),a("q-dialog",{model:{value:t.openHelp,callback:function(e){t.openHelp=e},expression:"openHelp"}},[a("q-card",{staticClass:"full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("如何標註")]),t._v(" "),a("ul",{staticClass:"text-subtitle2"},[a("li",[t._v("框選出影像中所有符合標籤的物件並選擇對應的標籤，完成後按「確定」送出。")]),t._v(" "),a("li",[t._v("優良的標註應符合以下條件：\n\t\t\t\t\t\t"),a("ol",[a("li",[t._v("框選出所有符合標籤的物件並選擇正確的物件標籤")]),t._v(" "),a("li",[t._v("方框應完整涵蓋該物件可以看到的範圍(不包含被遮住的部分)，並且盡量逼近該物件的大小")]),t._v(" "),a("li",[t._v("一個方框只能框一個物件，若有多個物件請分不同方框框選")])])])]),t._v(" "),a("div",{staticClass:"text-h6"},[t._v("如何驗證")]),t._v(" "),a("ol",{staticClass:"text-subtitle2"},[a("li",[t._v("確認影像中框選出的物件標籤是否正確")]),t._v(" "),a("li",[t._v("確認方框是否完整涵蓋該物件可以看到的範圍(不包含被遮住的部分)，並且盡量逼近該物件的大小")]),t._v(" "),a("li",[t._v("確認一個方框只能框一個物件，若有多個物件需分成不同方框框選")]),t._v(" "),a("li",[t._v("確認是否已框選出所有符合標籤的物件")]),t._v(" "),a("li",[t._v("若以上條件皆符合即為優良的標註，按「是」送出。反之按「否」。")])]),t._v(" "),a("div",{staticClass:"text-h6"},[t._v("參考資料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://vision.stanford.edu/pdf/bbox_submission.pdf",target:"_blank"}},[t._v("Su, H., Deng, J., & Fei-Fei, L. (2012). Crowdsourcing annotations for visual object detection. In AAAI human computation workshop.")])]),t._v(" "),a("li",[a("a",{attrs:{href:"https://chtseng.wordpress.com/2019/03/10/ai%e9%a0%98%e5%9f%9f%e7%9a%84%e8%97%8d%e9%a0%98%e5%b7%a5%e4%bd%9c-image-labeling/",target:"_blank"}},[t._v("AI領域的藍領工作- Image Labeling")])])])]),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1)],1)};i._withStripped=!0;var n={name:"annotator-bbox",components:{"tag-select":a(18).a},props:{dataset:Object,image:Object,task:String},data:function(){return{openHelp:!1,openTagSelect:!1,tool:"move",toolOption:[{value:"bbox",slot:"bbox"},{value:"move",slot:"move"}],container:null,stage:null,imageLayer:null,bboxLayer:null,imageNode:null,annotationArr:[],gesture:"",lastTouch:null,newRect:null,target:null,labelColor:{}}},mounted:function(){this.GenLabelColor(),this.InitCanvas()},methods:{GetRelativeMousePos:function(t){var e=t.getAbsoluteTransform().copy();e.invert();var a=t.getStage().getPointerPosition();return e.point(a)},HSVtoRGB:function(t,e,a,i){var n,s,o,r,l,c,h,u;switch(1===arguments.length&&(e=t.s,a=t.v,t=t.h),c=a*(1-e),h=a*(1-(l=6*t-(r=Math.floor(6*t)))*e),u=a*(1-(1-l)*e),r%6){case 0:n=a,s=u,o=c;break;case 1:n=h,s=a,o=c;break;case 2:n=c,s=a,o=u;break;case 3:n=c,s=h,o=a;break;case 4:n=u,s=c,o=a;break;case 5:n=a,s=c,o=h}return"rgba("+(n=Math.round(255*n))+","+(s=Math.round(255*s))+","+(o=Math.round(255*o))+","+i+")"},GenLabelColor:function(){this.labelColor={};for(var t=this.dataset.tagArr.length,e=0;e<t;e++){var a=e%5*.2,i=1-parseInt(.2*e)%5*.2,n=1-parseInt(.2*e*.2)%5*.2,s=this.HSVtoRGB(a,i,n,1),o=n>=.5?"#000000":"#ffffff",r=this.dataset.tagArr[e];this.labelColor[r]={fg:o,bg:s}}},BoundInImage:function(t){var e=this.imageNode.absolutePosition(),a=this.imageNode.size(),i=this.imageNode.getAbsoluteScale();return t.x<e.x&&(t.x=e.x),t.x>=e.x+a.width*i.x&&(t.x=e.x+a.width*i.x),t.y<e.y&&(t.y=e.y),t.y>=e.y+a.height*i.y&&(t.y=e.y+a.height*i.y),t},BoundStage:function(t){var e=this.stage.size(),a=this.imageNode.size(),i=this.stage.scale(),n=.5*(e.width-a.width)*i.x,s=.5*(e.height-a.height)*i.y,o=.5*(e.width+a.width)*i.x,r=.5*(e.height+a.height)*i.y;return a.width*i.x>e.width?t.x+n>0?t.x=-n:t.x+o<e.width&&(t.x=e.width-o):t.x+n<0?t.x=-n:t.x+o>e.width&&(t.x=e.width-o),a.height*i.y>e.height?t.y+s>0?t.y=-s:t.y+r<e.height&&(t.y=e.height-r):t.y+s<0?t.y=-s:t.y+r>e.height&&(t.y=e.height-r),t},InitCanvas:function(){this.container="view"==this.task?this.$refs.viewCanvas:this.$refs.editCanvas,this.stage=new Konva.Stage({container:this.container,width:this.container.clientWidth,height:this.container.clientHeight,draggable:!1,dragBoundFunc:this.BoundStage}),this.stage.content.style.margin="auto",this.tool="annotate"==this.task?"bbox":"move",this.ChangeTool(),this.stage.on("wheel",function(t){t.evt.preventDefault();var e=this.stage.scaleX(),a=t.evt.deltaY>0?.95*e:e/.95;a<1&&(a=1);var i=this.stage.getPointerPosition(),n=(i.x-this.stage.x())/e,s=(i.y-this.stage.y())/e;this.stage.scale({x:a,y:a});var o={x:-n*a+i.x,y:-s*a+i.y};o=this.BoundStage(o),this.stage.position(o),this.stage.batchDraw()}.bind(this)),this.stage.on("mousedown touchstart",function(t){if("touchstart"==t.type&&2==t.evt.touches.length)this.gesture="pinch",this.lastTouch=t;else if(this.gesture="drag","bbox"==this.tool){if(""!=t.target.name())return;var e=this.GetRelativeMousePos(this.stage);e=this.BoundInImage(e),this.lastTouch=this.stage.getPointerPosition(),this.newRect&&this.newRect.destroy(),this.newRect=new Konva.Rect({x:e.x,y:e.y,width:0,height:0,fill:"rgba(0,0,0,0)",stroke:"#ffffff"}),this.bboxLayer.add(this.newRect)}this.stage.batchDraw()}.bind(this)),this.stage.on("mousemove touchmove",function(t){if("pinch"==this.gesture){var e=this.lastTouch.evt.touches[0],a=this.lastTouch.evt.touches[1],i=t.evt.touches[0],n=t.evt.touches[1];if(this.lastTouch=t,!(e&&a&&i&&n))return;function s(t,e){var a=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(a*a+i*i)}var o=s(e,a),r=s(i,n),l=this.stage.scaleX(),c=r/o;c>1.1?c=1.1:c<.9&&(c=.9);var h=l*c;h<1&&(h=1);var u={x:.5*(i.clientX+n.clientX),y:.5*(i.clientY+n.clientY)},d={x:(u.x-this.stage.x())/l,y:(u.y-this.stage.y())/l};this.stage.scale({x:h,y:h});var g={x:-d.x*h+u.x,y:-d.y*h+u.y};g=this.BoundStage(g),this.stage.position(g)}else if("drag"==this.gesture)if("bbox"==this.tool){if(!this.newRect)return;var f=this.GetRelativeMousePos(this.stage);f=this.BoundInImage(f);var m=this.newRect.position();this.newRect.setAttrs({width:f.x-m.x,height:f.y-m.y})}else if("move"==this.tool){f=this.stage.getPointerPosition();if(!this.lastTouch)return void(this.lastTouch=f);var v=this.stage.position();g={x:v.x+f.x-this.lastTouch.x,y:v.y+f.y-this.lastTouch.y};this.lastTouch=f,g=this.BoundStage(g),this.stage.position(g)}this.stage.batchDraw()}.bind(this)),this.stage.on("mouseup touchend",function(t){if(this.lastTouch=null,"pinch"==this.gesture)this.gesture="";else if("drag"==this.gesture){if(this.gesture="","bbox"!=this.tool)return;if(!this.newRect)return;var e=this.newRect.size();if(Math.abs(e.width)<10||Math.abs(e.height)<10)return this.CancelTagSelect();this.openTagSelect=!0}}.bind(this)),this.imageLayer=new Konva.Layer,this.bboxLayer=new Konva.Layer,this.stage.add(this.imageLayer),this.stage.add(this.bboxLayer)},ChangeTool:function(){switch(this.tool){case"move":this.container.style.cursor="grab";break;case"bbox":this.container.style.cursor="default"}},ConfirmTagSelect:function(){if(this.target){var t=this.$refs.tagSelect.selectTag;if(!t||""==t)return alert("請選擇標籤");this.target.tag=t;var e=this.labelColor[t].bg,a=this.labelColor[t].fg;this.target.node.find("Rect")[0].setAttr("stroke",e);var i=this.target.node.find("Label")[0];i.getTag().setAttr("fill",e),i.getText().setAttr("fill",a).text(t),this.target=null,this.openTagSelect=!1,this.stage.batchDraw()}},CancelTagSelect:function(){this.openTagSelect=!1,this.target=null,this.newRect&&(this.newRect.destroy(),this.newRect=null),this.stage.batchDraw()},AddAnnotation:function(){if(this.newRect){var t=this.$refs.tagSelect.selectTag;if(!t||""==t)return alert("請選擇標籤");var e=this.newRect.position(),a=this.newRect.size();a.width<0&&(e.x=e.x+a.width,a.width=-a.width),a.height<0&&(e.y=e.y+a.height,a.height=-a.height);var i=new Konva.Group;this.bboxLayer.add(i);var n=new Konva.Rect({x:e.x,y:e.y,width:a.width,height:a.height,fill:"rgba(0,0,0,0)",stroke:this.labelColor[t].bg});i.add(n);var s=new Konva.Label({});s.add(new Konva.Tag({fill:this.labelColor[t].bg})),s.add(new Konva.Text({text:t,padding:3,fontSize:10,fill:this.labelColor[t].fg,name:"BBoxLabel"})),s.on("click tap",function(t){this.openTagSelect=!0,this.target=o,Vue.nextTick(function(){this.$refs.tagSelect.selectTag=o.tag}.bind(this))}.bind(this)),s.position({x:e.x,y:e.y-s.height()}),i.add(s);var o={tag:t,x:e.x,y:e.y,width:a.width,height:a.height,node:i,index:this.annotationArr.length};this.annotationArr.push(o);var r=function(t){var e=i.find(".LT")[0],a=i.find(".RT")[0],r=i.find(".RB")[0],l=i.find(".LB")[0];switch(t.getName()){case"LT":l.x(t.x()),a.y(t.y());break;case"RT":r.x(t.x()),e.y(t.y());break;case"RB":a.x(t.x()),l.y(t.y());break;case"LB":e.x(t.x()),r.y(t.y())}for(var c=[e,a,r,l],h=Number.MAX_VALUE,u=Number.MAX_VALUE,d=Number.MIN_VALUE,g=Number.MIN_VALUE,f=0;f<c.length;f++){var m=c[f].position(),v=c[f].size(),p=m.x+.5*v.width,b=m.y+.5*v.height;p<h&&(h=p),p>d&&(d=p),b<u&&(u=b),b>g&&(g=b)}var _=d-h,x=g-u;n.setAttrs({x:h,y:u,width:_,height:x}),o.x=h,o.y=u,o.width=_,o.height=x,s.setAttrs({x:h,y:u-s.height()}),this.stage.batchDraw()}.bind(this),l=function(t,e,a,i){var n=new Konva.Rect({x:e-5,y:a-5,width:10,height:10,fill:"#ffffff",stroke:"#3333ff",name:i,draggable:!0,dragBoundFunc:function(t){return t.x+=5,t.y+=5,(t=this.BoundInImage(t)).x-=5,t.y-=5,t}.bind(this)});n.on("dragmove",function(){r(n)}.bind(this)),t.add(n)}.bind(this);l(i,e.x,e.y,"LT"),l(i,e.x+a.width,e.y,"RT"),l(i,e.x+a.width,e.y+a.height,"RB"),l(i,e.x,e.y+a.height,"LB"),this.openTagSelect=!1,this.newRect.destroy(),this.newRect=null,this.stage.batchDraw()}},RemoveAnnotation:function(){this.target&&(this.target.node.destroy(),this.annotationArr.splice(this.target.index,1),this.target=null,this.openTagSelect=!1,this.stage.batchDraw())},ChangeImage:function(){this.imageNode&&this.imageNode.destroy();for(var t=0;t<this.annotationArr.length;t++){this.annotationArr[t].node.destroy()}this.annotationArr=[];var e=this.$refs.srcImage,a=this.container.clientWidth,i=this.container.clientHeight,n=a/e.width,s=i/e.height,o=Math.min(n,s),r=e.width*o,l=e.height*o;this.imageNode=new Konva.Image({x:.5*(a-r),y:.5*(i-l),width:r,height:l,image:e}),this.imageLayer.add(this.imageNode),"view"!=this.task&&"verify"!=this.task||this.DrawAnnotation(),this.stage.batchDraw()},DrawAnnotation:function(){if(this.image.annotation){for(var t=this.imageNode.position(),e=this.imageNode.size(),a=this.$refs.srcImage,i=0;i<this.image.annotation.annotation.length;i++){var n=this.image.annotation.annotation[i],s=parseFloat(n.x),o=parseFloat(n.y),r=parseFloat(n.width),l=parseFloat(n.height),c=new Konva.Group;this.bboxLayer.add(c);var h={x:s,y:o},u={x:s+r,y:o+l};h.x=h.x*e.width/a.width+t.x,h.y=h.y*e.height/a.height+t.y,u.x=u.x*e.width/a.width+t.x,u.y=u.y*e.height/a.height+t.y;var d=new Konva.Rect({x:h.x,y:h.y,width:u.x-h.x,height:u.y-h.y,fill:"rgba(0,0,0,0)",stroke:this.labelColor[n.tag].bg});c.add(d);var g=new Konva.Label({});g.add(new Konva.Tag({fill:this.labelColor[n.tag].bg})),g.add(new Konva.Text({text:n.tag,fontSize:10,padding:1,fill:this.labelColor[n.tag].fg,name:"BBoxLabel"})),g.position({x:h.x,y:h.y-g.height()}),c.add(g);var f={tag:n.tag,x:d.x(),y:d.y(),width:d.width(),height:d.height(),node:c,index:this.annotationArr.length};this.annotationArr.push(f)}this.stage.batchDraw()}},SetAnnotation:function(){if(0==this.annotationArr.length)return alert("請至少新增一個標籤");this.$emit("setAnnotation")},SetVerification:function(t){this.$emit("setVerification",t)},GetAnnotation:function(){for(var t=[],e=this.imageNode.position(),a=this.imageNode.size(),i=this.$refs.srcImage,n=0;n<this.annotationArr.length;n++){var s=this.annotationArr[n],o={},r={x:s.x,y:s.y},l={x:s.x+s.width,y:s.y+s.height};r.x=(r.x-e.x)*i.width/a.width,r.y=(r.y-e.y)*i.height/a.height,l.x=(l.x-e.x)*i.width/a.width,l.y=(l.y-e.y)*i.height/a.height,o.x=r.x,o.y=r.y,o.width=l.x-r.x,o.height=l.y-r.y,o.tag=s.tag,t.push(o)}return t},SkipTask:function(){this.$emit("skipTask")}}},s=(a(56),a(0)),o=Object(s.a)(n,i,[],!1,null,null,null);o.options.__file="src/vue/annotator-bbox.vue";e.a=o.exports},function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator-image"},["view"==t.task?a("div",{staticClass:"column fit"},[a("q-img",{staticClass:"col",attrs:{contain:"",src:t.image.url}},[t.image.annotation?a("div",{staticClass:"absolute-bottom text-subtitle1 text-center"},[t._v("\n\t\t\t\t"+t._s(t.image.annotation.annotation)+"\n\t\t\t")]):t._e()])],1):a("div",{staticClass:"column fit"},[a("q-img",{staticClass:"col q-my-md",attrs:{contain:"",src:t.image.url}}),t._v(" "),"annotate"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"確定"},on:{click:function(e){return t.SetAnnotation()}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,2135591169)},[a("div",{staticClass:"row items-center"},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t\t請選擇符合此影像的標籤\n\t\t\t\t")]),t._v(" "),a("tag-select",{ref:"tagSelect",staticClass:"tag-select",attrs:{dataset:t.dataset}})],1)]):t._e(),t._v(" "),"verify"==t.task?a("q-banner",{staticClass:"bg-grey-6 text-white col-shrink",attrs:{"inline-actions":""},scopedSlots:t._u([{key:"action",fn:function(){return[a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"是"},on:{click:function(e){return t.SetVerification(!0)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"否"},on:{click:function(e){return t.SetVerification(!1)}}}),t._v(" "),a("q-btn",{staticClass:"q-ma-xs bg-primary",attrs:{label:"略過"},on:{click:function(e){return t.SkipTask()}}})]},proxy:!0}],null,!1,767176183)},[a("div",{staticClass:"text-h6 inline-block"},[t._v("\n\t\t\t\t請驗證此影像是否為 "+t._s(t.image.annotation.annotation)+"?\n\t\t\t")])]):t._e()],1),t._v(" "),a("q-dialog",{model:{value:t.openHelp,callback:function(e){t.openHelp=e},expression:"openHelp"}},[a("q-card",{staticClass:"full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("如何標註")]),t._v(" "),a("ul",{staticClass:"text-subtitle2"},[a("li",[t._v("選擇符合此影像的標籤並按「確定」。")])]),t._v(" "),a("div",{staticClass:"text-h6"},[t._v("如何驗證")]),t._v(" "),a("ul",{staticClass:"text-subtitle2"},[a("li",[t._v("若此影像符合選擇的標籤，按「是」。反之按「否」。")])])]),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1)],1)};i._withStripped=!0;var n={name:"annotator-image",components:{"tag-select":a(18).a},props:{dataset:Object,image:Object,task:String,status:String},data:function(){return{openHelp:!1}},mounted:function(){},methods:{SetAnnotation:function(){this.$emit("setAnnotation")},SetVerification:function(t){this.$emit("setVerification",t)},GetAnnotation:function(){return this.$refs.tagSelect.selectTag},SkipTask:function(){this.$emit("skipTask")}}},s=(a(54),a(0)),o=Object(s.a)(n,i,[],!1,null,null,null);o.options.__file="src/vue/annotator-image.vue";e.a=o.exports},function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-card",{staticClass:"dataset-select full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇資料集")]),t._v(" "),t.lastDataset?a("div",[a("div",{staticClass:"text-subtitle2"},[t._v("上次使用")]),t._v(" "),a("q-item",{attrs:{clickable:"",active:-1==t.selectIndex,"active-class":"bg-green-2"},on:{click:function(e){return t.SelectItem(-1)},dblclick:function(e){return t.ConfirmSelect()}}},[a("q-item-section",{attrs:{avatar:""}},[a("q-avatar",{attrs:{square:"",rounded:""}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:t.lastDataset.picCover||"/static/image/logo-16-9.png"}})])],1),t._v(" "),a("q-item-section",[a("q-item-label",[t._v(t._s(t.lastDataset.name))])],1)],1)],1):t._e(),t._v(" "),a("q-scroll-area",{staticStyle:{height:"300px"}},[a("q-infinite-scroll",{ref:"datasetScroll",on:{load:t.LoadMoreDataset},scopedSlots:t._u([{key:"loading",fn:function(){return[a("div",{staticClass:"row justify-center q-my-md"},[a("q-spinner-dots",{attrs:{color:"primary",size:"40px"}})],1)]},proxy:!0}])},[a("q-input",{attrs:{placeholder:"輸入篩選文字",outlined:"",dense:"",square:""},on:{change:function(e){return t.ReloadDataset()}},model:{value:t.searchKey,callback:function(e){t.searchKey=e},expression:"searchKey"}}),t._v(" "),a("q-list",{attrs:{bordered:"",separator:""}},t._l(t.datasetArr,(function(e,i){return a("q-item",{key:i,attrs:{clickable:"",active:t.selectIndex==i,"active-class":"bg-green-2"},on:{click:function(e){return t.SelectItem(i)},dblclick:function(e){return t.ConfirmSelect()}}},[a("q-item-section",{attrs:{avatar:""}},[a("q-avatar",{attrs:{square:"",rounded:""}},[a("img",{staticStyle:{"object-fit":"cover"},attrs:{src:e.picCover||"/static/image/logo-16-9.png"}})])],1),t._v(" "),a("q-item-section",[a("q-item-label",[t._v(t._s(e.name))])],1)],1)})),1)],1)],1)],1),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{attrs:{flat:"",label:"確定"},on:{click:function(e){return t.ConfirmSelect()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"取消"},on:{click:function(e){return t.CancelSelect()}}})],1)],1)};i._withStripped=!0;var n={name:"dataset-select",props:{forUpload:Boolean,forAnnotation:Boolean},components:{},data:function(){return{searchKey:"",datasetArr:[],hasMore:!0,selectIndex:-1,lastDataset:{}}},created:function(){this.GetLastDataset()},methods:{GetLastDataset:function(){window.localStorage;this.lastDataset=JSON.parse(localStorage.getItem("lastDataset"))},SetLastDataset:function(t){window.localStorage;localStorage.setItem("lastDataset",JSON.stringify(t))},LoadMoreDataset:function(t,e){var a="/dataset/list-dataset";a+="?page="+(t-1),a+="&sort=updatedAt",a+="&orderType=desc",this.forUpload&&(a+="&enableUpload=1"),this.forAnnotation&&(a+="&enableAnnotation=1"),a+="&keyword="+this.searchKey,$.get(a,function(t){"ok"==t.status&&(this.hasMore=t.data.hasMore,this.hasMore||this.$refs.datasetScroll.stop(),this.datasetArr=this.datasetArr.concat(t.data.dataset),e())}.bind(this))},ReloadDataset:function(){this.datasetArr=[],this.$refs.datasetScroll.reset(),this.$refs.datasetScroll.resume(),this.selectIndex=-1},GetSelectDataset:function(){return-1==this.selectIndex&&this.lastDataset?this.lastDataset:this.selectIndex<0||this.selectIndex>=this.datasetArr.length?null:this.datasetArr[this.selectIndex]},SelectItem:function(t){this.selectIndex=t,this.$emit("change")},ConfirmSelect:function(){return-1==this.selectIndex&&this.lastDataset?this.$emit("confirm"):this.selectIndex<0||this.selectIndex>=this.datasetArr.length?alert("請選擇資料集"):(this.SetLastDataset(this.datasetArr[this.selectIndex]),void this.$emit("confirm"))},CancelSelect:function(){this.$emit("cancel")}}},s=(a(48),a(0)),o=Object(s.a)(n,i,[],!1,null,null,null);o.options.__file="src/vue/dataset-select.vue";e.a=o.exports},function(t,e,a){var i=a(1),n=a(24);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){(e=a(2)(!1)).push([t.i,'html,body{height:100%;margin:0;padding:0;background-color:#edffef}*{box-sizing:border-box;font-family:"微軟正黑體", "Microsoft JhengHei"}\n',""]),t.exports=e},,function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.dataset?a("q-card",{staticClass:"image-info full-width q-pa-sm"},[a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇資料時間")]),t._v(" "),a("input",{directives:[{name:"model",rawName:"v-model",value:t.dataTime,expression:"dataTime"}],staticClass:"q-pa-sm",attrs:{type:"datetime-local"},domProps:{value:t.dataTime},on:{change:function(e){return t.$emit("change")},input:function(e){e.target.composing||(t.dataTime=e.target.value)}}})]),t._v(" "),t.dataset.enableGPS?a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("選擇資料地點")]),t._v(" "),a("location-select",{ref:"locationSelect",attrs:{mode:"selectLoc"}}),t._v(" "),t.$refs.locationSelect?a("div",{staticClass:"text-center"},[t._v(t._s(t.$refs.locationSelect.status))]):t._e()],1):t._e(),t._v(" "),a("q-card-section",[a("div",{staticClass:"text-h6"},[t._v("資料備註說明(若無備註說明請直接按確定)")]),t._v(" "),a("q-input",{attrs:{filled:"",type:"textarea"},on:{input:function(e){return t.$emit("change")}},model:{value:t.remark,callback:function(e){t.remark=e},expression:"remark"}})],1),t._v(" "),a("q-card-actions",{staticClass:"justify-center"},[a("q-btn",{attrs:{flat:"",label:"確定"},on:{click:function(e){return t.ConfirmSelect()}}}),t._v(" "),a("q-btn",{attrs:{flat:"",label:"取消"},on:{click:function(e){return t.CancelSelect()}}})],1)],1):t._e()};i._withStripped=!0;var n=a(6),s={name:"image-info",props:{dataset:Object,initDataTime:String,initLat:Number,initLng:Number,initRemark:String},components:{"location-select":n.a},data:function(){return{dataTime:null,remark:""}},mounted:function(){var t=spacetime().name;this.initDataTime?this.dataTime=spacetime(this.initDataTime).goto(t).unixFmt("yyyy-MM-ddTHH:mm"):this.dataTime=spacetime.now().unixFmt("yyyy-MM-ddTHH:mm"),this.initLat&&this.initLng?this.$refs.locationSelect.SetPosition(this.initLat,this.initLng):this.dataset.enableGPS&&this.$refs.locationSelect.GetGPS(),this.initRemark&&(this.remark=this.initRemark)},methods:{GetImageInfo:function(){var t={},e=spacetime.now();return t.dataTime=spacetime(this.dataTime,e.timezone().name).format("iso"),t.remark=this.remark,this.$refs.locationSelect&&(t.loc=this.$refs.locationSelect.loc),t},ConfirmSelect:function(){this.$emit("confirm")},CancelSelect:function(){this.$emit("cancel")}}},o=(a(50),a(0)),r=Object(o.a)(s,i,[],!1,null,null,null);r.options.__file="src/vue/image-info.vue";e.a=r.exports},,function(t,e,a){"use strict";var i=a(4);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".topbar{width:100%}.topbar a{text-decoration:none}\n",""]),t.exports=e},,,,,function(t,e,a){var i=a(1),n=a(83);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},function(t,e,a){var i=a(1),n=a(85);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},,function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator bg-grey-9"},[t.datasetSelect&&t.imageSelect&&t.taskSelect?a("div",{staticClass:"fit"},["image"==t.datasetSelect.annotationType?a("annotator-image",{ref:"annotatorImage",attrs:{dataset:t.datasetSelect,image:t.imageSelect,task:t.taskSelect},on:{setAnnotation:t.UploadAnnotation,setVerification:t.UploadVerification,skipTask:t.SkipTask}}):t._e(),t._v(" "),"bbox"==t.datasetSelect.annotationType?a("annotator-bbox",{ref:"annotatorBBox",attrs:{dataset:t.datasetSelect,image:t.imageSelect,task:t.taskSelect},on:{setAnnotation:t.UploadAnnotation,setVerification:t.UploadVerification,skipTask:t.SkipTask}}):t._e()],1):a("div",{staticClass:"fit row justify-center items-center"},[a("div",{staticClass:"text-h5 text-white"},[t._v(t._s(t.status))])]),t._v(" "),a("q-dialog",{model:{value:t.openDatasetSelect,callback:function(e){t.openDatasetSelect=e},expression:"openDatasetSelect"}},[a("dataset-select",{ref:"datasetSelect",attrs:{forAnnotation:""},on:{confirm:function(e){return t.ChangeDataset()},cancel:function(e){t.openDatasetSelect=!1}}})],1),t._v(" "),a("q-page-sticky",{attrs:{position:"top-left",offset:[18,18]}},[a("div",{staticClass:"column q-gutter-sm"},[a("q-btn",{staticClass:"bg-primary text-white",attrs:{flat:"",round:"",size:"md",icon:"help",disable:null==t.imageSelect},on:{click:function(e){return t.OpenHelp()}}},[a("q-tooltip",{attrs:{"content-class":"bg-primary"}},[t._v("如何標註")])],1),t._v(" "),a("q-btn",{staticClass:"bg-primary text-white",attrs:{flat:"",round:"",size:"md",icon:"view_quilt",disable:null!=t.dataset},on:{click:function(e){t.openDatasetSelect=!0}}},[a("q-tooltip",{attrs:{"content-class":"bg-primary"}},[t._v("選擇資料集")])],1)],1)])],1)};i._withStripped=!0;var n=a(22),s=a(21),o=a(20),r={name:"annotator",components:{"dataset-select":n.a,"annotator-image":s.a,"annotator-bbox":o.a},props:{user:Object,dataset:Object,image:Object,autoTask:Boolean},data:function(){return{datasetSelect:null,imageSelect:null,taskSelect:"",openDatasetSelect:!1,imageArr:[],status:"",verify:null}},mounted:function(){this.user||(window.location.href="/login?intentUrl="+encodeURIComponent(window.location.pathname+window.location.search)),this.datasetSelect=this.dataset,this.imageSelect=this.image,this.dataset?this.GenerateTask():(this.status="請選擇資料集",this.openDatasetSelect=!0)},methods:{ChangeDataset:function(){this.openDatasetSelect=!1,this.datasetSelect=this.$refs.datasetSelect.GetSelectDataset();var t="/dataset/list-image-for-annotation";t+="?dataset="+this.datasetSelect._id,$.get(t,function(t){if("ok"==t.status){for(var e=0;e<t.data.length;e++){var a=t.data[e];a.url="/static/upload/dataset/"+this.datasetSelect._id+"/image/"+a._id+".jpg"}this.imageArr=t.data,this.GenerateTask()}}.bind(this))},GenerateTask:function(){if(this.imageSelect=null,this.datasetSelect){if(this.image){if(this.image.annotation)if(this.image.verification.filter(function(t){return t.user==this.user._id}.bind(this)).length>0)return void(this.status="您已驗證過此影像，感謝您的協助");this.imageSelect=this.image}else{if(0==this.imageArr.length)return void(this.status="此資料集影像皆已標註完成");for(var t=[],e=0;e<this.imageArr.length;e++){var a=this.imageArr[e];if(a.annotation)0==a.verification.filter(function(t){return t.user==this.user._id}.bind(this)).length&&t.push(a);else t.push(a)}if(0==t.length)return void(this.status="您已驗證過此資料集所有資料，感謝您的協助");var i=function(){if(0==t.length)return null;var e=Math.floor(Math.random()*t.length);return t[e]}.bind(this);this.imageSelect=i()}var n=function(){this.imageSelect.annotation?this.imageSelect.verifyNum<this.verify.sample?this.taskSelect="verify":this.imageSelect.agreeNum<this.imageSelect.verifyNum*this.verify.reject?this.taskSelect="annotate":this.taskSelect="verify":this.taskSelect="annotate"}.bind(this);this.verify?n():$.get("/dataset/verify-condition",function(t){if("ok"!=t.status)return alert("讀取驗證條件失敗");this.verify=t.data,n()}.bind(this))}else this.status="請選擇資料集"},GetAnnotator:function(){if(!this.datasetSelect)return null;var t=null;switch(this.datasetSelect.annotationType){case"image":t=this.$refs.annotatorImage;break;case"bbox":t=this.$refs.annotatorBBox}return t},UploadAnnotation:function(){var t=this.GetAnnotator();if(t){var e=$("meta[name='csrf-token']").attr("content"),a={};a.dataset=t.dataset._id,a.image=t.image._id,a.annotation=t.GetAnnotation(),a._csrf=e,$.post("/dataset/set-annotation",a,function(t){if("ok"!=t.status)switch(t.message){case"blacklist":return alert("黑名單使用者無此權限");default:return alert("標註失敗")}this.imageSelect.annotation={user:this.user._id,annotation:a.annotation},this.$q.notify("標註成功"),this.autoTask?this.GenerateTask():this.$emit("done")}.bind(this))}},UploadVerification:function(t){var e=this.GetAnnotator();if(e){var a=$("meta[name='csrf-token']").attr("content"),i={};i.dataset=e.dataset._id,i.image=e.image._id,i.agree=t?"1":"0",i._csrf=a,$.post("/dataset/add-verification",i,function(t){if("ok"!=t.status)switch(t.message){case"verification duplicate":this.$q.notify("您之前已驗證過這個標註");break;case"blacklist":alert("黑名單使用者無此權限");break;default:alert("驗證失敗")}else this.$q.notify("驗證成功");this.imageSelect.verification.push({user:this.user._id,agree:i.agree}),this.autoTask?this.GenerateTask():this.$emit("done")}.bind(this))}},OpenHelp:function(){var t=this.GetAnnotator();t&&(t.openHelp=!0)},SkipTask:function(){this.autoTask?this.GenerateTask():this.$emit("skip")}}},l=(a(58),a(0)),c=Object(l.a)(r,i,[],!1,null,null,null);c.options.__file="src/vue/annotator.vue";e.a=c.exports},function(t,e,a){"use strict";var i=a(5);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".location-select{width:100%}.location-select .map{width:100%;height:300px}\n",""]),t.exports=e},,,,,,,,,function(t,e,a){"use strict";var i=a(11);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".dataset-select{width:100%}\n",""]),t.exports=e},function(t,e,a){"use strict";var i=a(12);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".image-info{width:100%;height:100%}\n",""]),t.exports=e},function(t,e,a){"use strict";var i=a(13);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".tag-select{width:100%}\n",""]),t.exports=e},function(t,e,a){"use strict";var i=a(14);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".annotator-image{width:100%;height:100%}.annotator-image .image{margin:auto;max-width:800px;max-height:100%}.annotator-image .tag-select{width:150px;display:inline-block;padding:0px 5px}\n",""]),t.exports=e},function(t,e,a){"use strict";var i=a(15);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".annotator-bbox{width:100%;height:100%;position:relative}.annotator-bbox .tool-set{position:absolute;display:inline-block;bottom:10px;left:10px}\n",""]),t.exports=e},function(t,e,a){"use strict";var i=a(16);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".annotator{width:100%;height:100%}\n",""]),t.exports=e},,function(t,e,a){"use strict";var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return t.dataset&&t.image?a("div",{staticClass:"image-control"},[a("q-card",{staticClass:"full-width"},[a("div",{staticStyle:{height:"400px"}},[a("annotator-view",{attrs:{dataset:t.dataset,image:t.image}}),t._v(" "),t.showNavigate?a("div",[a("q-page-sticky",{attrs:{position:"left",offset:[18,0]}},[a("q-btn",{attrs:{round:"",color:"accent",icon:"arrow_back"},on:{click:function(e){return t.GoToPrev()}}})],1),t._v(" "),a("q-page-sticky",{attrs:{position:"right",offset:[18,0]}},[a("q-btn",{staticClass:"rotate-90",attrs:{round:"",color:"accent",icon:"arrow_upward"},on:{click:function(e){return t.GoToNext()}}})],1),t._v(" "),a("q-page-sticky",{attrs:{position:"top-right",offset:[18,-18]}},[a("q-btn",{attrs:{round:"",color:"primary",icon:"close"},on:{click:function(e){return t.CloseView()}}})],1)],1):t._e()],1),t._v(" "),a("q-card-section",[t.image.time?a("q-chip",{staticClass:"transparent",attrs:{dense:"",icon:"access_time"}},[t._v(t._s(t.image.time))]):t._e(),t._v(" "),t.image.lat&&t.image.lng?a("q-chip",{staticClass:"transparent",attrs:{dense:"",clickable:"",icon:"room"},on:{click:function(e){return t.ViewLocation()}}},[t._v("觀看地點")]):t._e(),t._v(" "),t.image.annotation?a("q-chip",{staticClass:"transparent",attrs:{dense:""}},[t._v(t._s("認同數 / 驗證數 : "+t.AgreeVerifyRatio))]):t._e(),t._v(" "),t.image.remark&&""!=t.image.remark?a("pre",{staticClass:"q-mx-sm q-my-none"},[t._v(t._s(t.image.remark))]):t._e()],1),t._v(" "),a("q-card-actions",[t.editable?a("div",[t.dataset&&t.dataset.enableAnnotation?a("q-btn",{attrs:{flat:"",label:t.image.annotation?"協助驗證":"協助標註"},on:{click:function(e){return t.AnnotateImage()}}}):t._e(),t._v(" "),a("q-btn",{attrs:{flat:"",label:"影像網址"},on:{click:function(e){return t.GoToImageUrl()}}}),t._v(" "),t.CheckAnnotationDelete?a("q-btn",{attrs:{flat:"",label:"刪除標註"},on:{click:function(e){return t.DeleteAnnotation()}}}):t._e(),t._v(" "),t.CheckMasterAuth?a("q-btn",{attrs:{flat:"",label:"編輯資訊"},on:{click:function(e){return t.OpenInfoEditor()}}}):t._e(),t._v(" "),t.CheckMasterAuth?a("q-btn",{attrs:{flat:"",label:"刪除影像"},on:{click:function(e){return t.DeleteImage()}}}):t._e()],1):t._e(),t._v(" "),t.dataset&&"riverlog"==t.dataset.externalLink?a("q-btn",{attrs:{flat:"",label:"前往山河事件簿"},on:{click:function(e){return t.GoToExternalLink()}}}):t._e(),t._v(" "),t.dataset&&"purbao"==t.dataset.externalLink?a("q-btn",{attrs:{flat:"",label:"前往紫豹在哪裡"},on:{click:function(e){return t.GoToExternalLink()}}}):t._e()],1)],1),t._v(" "),t.dataset?a("q-dialog",{attrs:{maximized:"",persistent:""},model:{value:t.openAnnotator,callback:function(e){t.openAnnotator=e},expression:"openAnnotator"}},[a("annotator",{attrs:{user:t.user,dataset:t.dataset,image:t.image},on:{done:function(e){return t.FinishAnnotation()},skip:function(e){t.openAnnotator=!1}}}),t._v(" "),a("div",[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],staticClass:"bg-teal text-white q-ma-md absolute-top-right",attrs:{round:"",icon:"close"}})],1)],1):t._e(),t._v(" "),t.editImage?a("q-dialog",{model:{value:t.openInfoEdit,callback:function(e){t.openInfoEdit=e},expression:"openInfoEdit"}},[a("image-info",{ref:"imageInfo",attrs:{dataset:t.dataset,initDataTime:t.editImage.dataTime,initLat:t.editImage.lat,initLng:t.editImage.lng,initRemark:t.editImage.remark},on:{confirm:function(e){return t.UpdateImageInfo()},cancel:function(e){t.openInfoEdit=!1}}})],1):t._e(),t._v(" "),t.image&&t.image.lat&&t.image.lng?a("q-dialog",{model:{value:t.openLocationView,callback:function(e){t.openLocationView=e},expression:"openLocationView"}},[a("q-card",{staticClass:"full-width q-pa-sm"},[a("div",{staticClass:"text-h6"},[t._v("資料地點")]),t._v(" "),a("location-select",{ref:"locationSelect",attrs:{mode:"view"}}),t._v(" "),a("div",{staticClass:"text-center"},[t._v("座標: "+t._s(t.image.lat.toFixed(5)+" "+t.image.lng.toFixed(5)))]),t._v(" "),a("q-card-actions",{attrs:{align:"center"}},[a("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"確定"}})],1)],1)],1):t._e()],1):t._e()};i._withStripped=!0;var n=a(37),s=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"annotator-view bg-grey-7"},[t.dataset&&t.image?a("div",{staticClass:"fit"},["image"==t.dataset.annotationType?a("annotator-image",{attrs:{dataset:t.dataset,image:t.image,task:"view"}}):t._e(),t._v(" "),"bbox"==t.dataset.annotationType?a("annotator-bbox",{attrs:{dataset:t.dataset,image:t.image,task:"view"}}):t._e()],1):a("div",{staticClass:"fit row justify-center items-center"},[a("div",{staticClass:"text-h5 text-white"},[t._v("無影像")])])])};s._withStripped=!0;var o=a(21),r=a(20),l={name:"annotator-view",components:{"annotator-image":o.a,"annotator-bbox":r.a},props:{dataset:Object,image:Object},data:function(){return{}},mounted:function(){},methods:{}},c=(a(82),a(0)),h=Object(c.a)(l,s,[],!1,null,null,null);h.options.__file="src/vue/annotator-view.vue";var u=h.exports,d=a(6),g=a(26),f={name:"image-control",props:{user:Object,dataset:Object,image:Object,showNavigate:Boolean,editable:Boolean},components:{annotator:n.a,"annotator-view":u,"location-select":d.a,"image-info":g.a},data:function(){return{openAnnotator:!1,openLocationView:!1,openInfoEdit:!1,editImage:null}},mounted:function(){},methods:{GoToPrev:function(){this.$emit("goToPrev")},GoToNext:function(){this.$emit("goToNext")},CloseView:function(){this.$emit("closeView")},AnnotateImage:function(){this.openAnnotator=!0},FinishAnnotation:function(){this.openAnnotator=!1,this.openViewImage=!1,this.$emit("reload")},ViewLocation:function(){this.openLocationView=!0,Vue.nextTick(function(){this.$refs.locationSelect.SetPosition(this.image.lat,this.image.lng)}.bind(this))},OpenInfoEditor:function(){$.get("/dataset/view-image?dataset="+this.dataset._id+"&image="+this.image._id,function(t){if("ok"!=t.status)return window.location.href="/?message="+encodeURIComponent("無法顯示影像");var e=spacetime().name;if(this.editImage=t.data,this.editImage.dataTime){var a=spacetime(this.editImage.dataTime).goto(e);this.editImage.time=a.unixFmt("yyyy-MM-dd HH:mm:ss")}this.editImage.url="/static/upload/dataset/"+this.dataset._id+"/image/"+this.image._id+".jpg",this.openInfoEdit=!0}.bind(this))},UpdateImageInfo:function(){var t=$("meta[name='csrf-token']").attr("content"),e=this.$refs.imageInfo.GetImageInfo(),a={};a.dataset=this.dataset._id,a.image=this.image._id,a.dataTime=e.dataTime,a.remark=e.remark,e.loc&&(a.lat=e.loc.lat,a.lng=e.loc.lng),a._csrf=t,$.post("/dataset/update-image-info",a,function(t){if("ok"!=t.status)return alert("更新失敗");this.$emit("reload"),this.openInfoEdit=!1,this.$q.notify("更新成功")}.bind(this))},DeleteImage:function(){if(confirm("確定刪除此影像?")){var t=$("meta[name='csrf-token']").attr("content"),e={};e.dataset=this.dataset._id,e.image=this.image._id,e._csrf=t,$.post("/dataset/delete-image",e,function(t){if("ok"!=t.status)return alert("刪除失敗");this.$emit("reload"),this.$q.notify("刪除成功")}.bind(this))}},GoToImageUrl:function(){this.image&&window.open("/image?dataset="+this.dataset._id+"&image="+this.image._id,"_blank")},DeleteAnnotation:function(){if(confirm("確定刪除此影像的標註?")){this.openViewImage=!1;var t=$("meta[name='csrf-token']").attr("content"),e={};e.dataset=this.dataset._id,e.image=this.image._id,e._csrf=t,$.post("/dataset/set-annotation",e,function(t){if("ok"!=t.status)return alert("刪除標註失敗");this.$q.notify("刪除標註成功"),this.$emit("reload")}.bind(this))}}},computed:{AgreeVerifyRatio:function(){var t=this.image.agreeNum+" / "+this.image.verifyNum;return this.image.verifyNum>0&&(t+=" ("+(100*this.image.agreeNum/this.image.verifyNum).toFixed(0)+"%)"),t},CheckAnnotationDelete:function(){return!!this.user&&(!!this.image&&(!!this.image.annotation&&("admin"==this.user.authType||(this.image.annotation.user==this.user._id||!!this.info&&this.info.master.filter(function(t){return t._id==this.user._id}.bind(this)).length>0))))},CheckMasterAuth:function(){return!!this.user&&("admin"==this.user.authType||!!this.dataset&&this.dataset.master.filter(function(t){return t._id==this.user._id}.bind(this)).length>0)}}},m=(a(84),Object(c.a)(f,i,[],!1,null,null,null));m.options.__file="src/vue/image-control.vue";e.a=m.exports},,,,,,,,,,,,function(t,e,a){var i=a(1),n=a(113);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var s={insert:"head",singleton:!1},o=(i(t.i,n,s),n.locals?n.locals:{});t.exports=o},,,,,,,,,function(t,e,a){"use strict";var i=a(34);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".annotator-view{width:100%;height:100%}\n",""]),t.exports=e},function(t,e,a){"use strict";var i=a(35);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".image-control{width:100%;height:100%}\n",""]),t.exports=e},,,,,,,,,,,,,,,,,,,,,,,,,,function(t,e,a){t.exports=a(117)},function(t,e,a){"use strict";var i=a(73);a.n(i).a},function(t,e,a){(e=a(2)(!1)).push([t.i,".image-view{width:100%;height:100%}\n",""]),t.exports=e},,,,function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-layout",{staticClass:"image-view bg-grey-1 shadow-2",attrs:{view:"lHh lpr lFf",container:""}},[a("q-header",[a("topbar",{attrs:{user:t.user}})],1),t._v(" "),a("q-page-container",[a("image-control",{attrs:{user:t.user,dataset:t.dataset,image:t.image}})],1),t._v(" "),a("q-footer",[a("q-btn",{staticClass:"full-width bg-grey-8",attrs:{icon:"home",label:"回資料集"},on:{click:function(e){return t.GoToDataset()}}})],1)],1)};i._withStripped=!0;var n=a(3),s=(a(23),a(17)),o=a(61),r={name:"image-view",components:{topbar:s.a,"image-control":o.a},data:function(){return{user:null,datasetID:null,imageID:null,dataset:null,image:null}},created:function(){var t=n.a.GetUrlParameter();this.datasetID=t.dataset,this.imageID=t.image,$.get("/user/info",function(t){"ok"==t.status&&(this.user=t.data)}.bind(this)),$.get("/dataset/view-dataset?id="+this.datasetID,function(t){if("ok"!=t.status)return window.location.href="/?message="+encodeURIComponent("無法顯示資料集");this.dataset=t.data,$.get("/dataset/view-image?dataset="+this.datasetID+"&image="+this.imageID,function(t){if("ok"!=t.status)return window.location.href="/?message="+encodeURIComponent("無法顯示影像");var e=spacetime().name;if(this.image=t.data,this.image.dataTime){var a=spacetime(this.image.dataTime).goto(e);this.image.time=a.unixFmt("yyyy-MM-dd HH:mm:ss")}this.image.url="/static/upload/dataset/"+this.datasetID+"/image/"+this.imageID+".jpg"}.bind(this))}.bind(this))},methods:{GoToDataset:function(){window.location.href="/dataset?id="+this.datasetID}}},l=(a(112),a(0)),c=Object(l.a)(r,i,[],!1,null,null,null);c.options.__file="src/vue/image-view.vue";var h=c.exports;new Vue({el:"#imageViewApp",components:{"image-view":h}})}]);